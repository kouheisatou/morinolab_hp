<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="build-timestamp" content="1750311973685" />
    <!-- Build timestamp: 2025-06-19T05:46:13.685Z -->
    <title>Morinolab CMS</title>
    <style>
      body {
        margin: 0;
        font-family: 'Chicago', 'Geneva', sans-serif;
        display: flex;
        height: 100vh;
        background: #c0c0c0; /* classic gray */
        color: #000;
      }
      #sidebar {
        flex: 0 0 180px; /* fixed width */
        width: 180px;
        background: #d4d0c8;
        border-right: 2px solid #808080;
        overflow-y: auto;
        overflow-x: hidden; /* disable horizontal scroll */
      }
      #sidebar button {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        color: #000;
        text-align: left;
        cursor: pointer;
        font-size: 13px;
        margin: 2px 0; /* vertical margin only to avoid width overflow */
      }
      #sidebar button:hover {
        background: #c8c4bc;
      }
      #sidebar button:active {
        border-top-color: #808080;
        border-left-color: #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
      }
      #sidebar button.active {
        position: relative;
        background: #d4d0c8; /* same as sidebar */
        color: #000;
        font-weight: bold;
      }
      #sidebar button.active::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 4px;
        background: #000080;
      }
      #main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: auto; /* allow scroll when content wider */
      }
      #items {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: #c0c0c0;
      }
      #editor {
        flex: 1;
        display: none;
        flex-direction: column;
      }
      #editorHeader {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #d4d0c8;
        border-bottom: 2px solid #808080;
        padding: 6px 8px;
      }
      #editorHeader h2 {
        flex: 1;
        margin: 0;
        font-size: 14px;
        font-weight: bold;
      }
      #editor textarea {
        flex: 1;
        resize: none;
        font-family: monospace;
        font-size: 14px;
        padding: 12px;
      }
      table {
        width: max-content; /* prevent squeezing, enable horizontal scroll */
        border-collapse: collapse;
        border: 2px solid #808080;
      }
      th,
      td {
        padding: 4px 8px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        text-align: left;
        background: #e0e0e0;
      }
      th {
        background: #d4d0c8;
        font-weight: bold;
      }
      .btn {
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 13px;
        color: #000;
        margin: 2px;
      }
      .btn:hover {
        background: #c8c4bc;
      }
      .btn:active {
        border-top-color: #808080;
        border-left-color: #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
      }
      .btn.add {
        background: #c0d6c0;
      }
      .btn.edit {
        background: #c0c8d6;
      }
      .btn.danger {
        background: #d6c0c0;
      }
      /* Mac OS 9 style scrollbars (WebKit-based browsers) */
      ::-webkit-scrollbar {
        width: 16px;
        height: 16px;
        background: #d4d0c8;
      }
      ::-webkit-scrollbar-track {
        background: #d4d0c8;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
      }
      ::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #b0b0b0;
      }
      ::-webkit-scrollbar-corner {
        background: #d4d0c8;
      }
      /* popup */
      #popupOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      #popup {
        background: #d4d0c8;
        border: 2px solid #808080;
        padding: 12px;
        max-height: 70vh;
        overflow: auto;
        min-width: 300px;
      }
      #popup h3 {
        margin-top: 0;
      }
      #popup .choices {
        max-height: 50vh;
        overflow: auto;
        margin-bottom: 12px;
      }
      #popup button {
        margin-right: 6px;
      }
      #popup .choices input[type='checkbox'],
      #popup .choices input[type='radio'] {
        appearance: none;
        width: 12px;
        height: 12px;
        margin-right: 4px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        vertical-align: middle;
      }
      #popup .choices input[type='checkbox']:checked,
      #popup .choices input[type='radio']:checked {
        background: #000080;
      }
      #popup .choices input[type='radio'] {
        border-radius: 50%;
      }
      .dropdownBtn {
        display: block;
        margin: 0 auto;
        padding: 2px 6px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        cursor: pointer;
        font-size: 12px;
      }
      .dropdownBtn:hover {
        background: #c8c4bc;
      }
      .dropdownBtn:active {
        border-top-color: #808080;
        border-left-color: #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
      }

      /* Initial Setup Screen */
      #initialSetup {
        position: fixed;
        inset: 0;
        background: #c0c0c0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      #initialSetup.hidden {
        display: none;
      }

      .setup-container {
        background: #d4d0c8;
        border: 2px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        padding: 24px;
        max-width: 700px;
        width: 90%;
      }

      .setup-step {
        background: #f8f8f8;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .setup-title {
        margin: 0 0 16px 0;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
      }

      .setup-description {
        margin: 0 0 20px 0;
        font-size: 14px;
        line-height: 1.4;
        text-align: center;
        color: #333;
      }

      .setup-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .setup-form label {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .setup-form input {
        padding: 4px;
        border: 1px solid #808080;
        border-top-color: #000;
        border-left-color: #000;
        font-size: 14px;
      }

      .setup-form .form-group {
        display: flex;
        flex-direction: column;
      }

      .setup-form .note {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      /* Progress Bar */
      .progress-container {
        margin: 20px 0;
        display: none;
      }

      .progress-container.show {
        display: block;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        border: 1px solid #808080;
        border-top-color: #000;
        border-left-color: #000;
        background: #c0c0c0;
        position: relative;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #000080;
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.2) 2px,
          rgba(255, 255, 255, 0.2) 4px
        );
      }

      .progress-text {
        text-align: center;
        margin-top: 8px;
        font-size: 12px;
        color: #333;
      }

      /* Repository Selection */
      .repo-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #808080;
        border-top-color: #000;
        border-left-color: #000;
        background: #fff;
        margin: 12px 0;
      }

      .repo-item {
        padding: 8px;
        border-bottom: 1px solid #d0d0d0;
        cursor: pointer;
        display: flex;
        flex-direction: column;
      }

      .repo-item:hover {
        background: #e0e0e0;
      }

      .repo-item.selected {
        background: #000080;
        color: #fff;
      }

      .repo-name {
        font-weight: bold;
        margin-bottom: 2px;
      }

      .repo-description {
        font-size: 12px;
        color: #666;
      }

      .repo-item.selected .repo-description {
        color: #ccc;
      }

      .repo-meta {
        font-size: 11px;
        margin-top: 4px;
        display: flex;
        gap: 8px;
      }

      .repo-private {
        background: #d6c0c0;
        padding: 1px 4px;
        border-radius: 2px;
      }

      .repo-item.selected .repo-private {
        background: rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- Initial Setup Screen -->
    <div id="initialSetup">
      <div class="setup-container">
        <h1 class="setup-title">GitHub CMS ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>

        <!-- Step 1: Local Directory Setup -->
        <div id="stepLocalPath" class="setup-step">
          <h2 style="font-size: 16px; margin: 0 0 12px 0">ğŸ“ ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å…ˆã®è¨­å®š</h2>
          <p style="margin: 0 0 16px 0; color: #666">
            GitHubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚<br />
            é¸æŠã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«å„ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
          </p>

          <div class="form-group">
            <label for="localPath">ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:</label>
            <div style="display: flex; gap: 8px; margin-top: 4px">
              <input
                type="text"
                id="localPath"
                style="flex: 1"
                placeholder="ä¾‹: /Users/username/Documents/github-repos"
              />
              <button id="selectDirBtn" class="btn" style="padding: 8px 12px">ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
            </div>
            <div class="note" style="margin-top: 8px">
              ğŸ’¡ ä¾‹: /Users/username/Documents/github-repos ã‚’é¸æŠã—ãŸå ´åˆã€<br />
              ãƒªãƒã‚¸ãƒˆãƒªã¯ /Users/username/Documents/github-repos/repo-name/ ã«ä¿å­˜ã•ã‚Œã¾ã™
            </div>
          </div>

          <button
            id="nextToAuthBtn"
            class="btn"
            style="padding: 12px 24px; margin-top: 16px; background: #c0d6c0"
            disabled
          >
            æ¬¡ã¸ï¼šGitHubã«ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>

        <!-- Step 2: GitHub Authentication -->
        <div id="stepAuth" class="setup-step" style="display: none">
          <h2 style="font-size: 16px; margin: 0 0 12px 0">ğŸ” ã‚¹ãƒ†ãƒƒãƒ—2: GitHubèªè¨¼</h2>
          <p style="margin: 0 0 16px 0; color: #666">
            GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ã‚’å–å¾—ã—ã¾ã™ã€‚
          </p>

          <div
            style="background: #f0f0f0; padding: 12px; margin-bottom: 16px; border: 1px solid #ccc"
          >
            <strong>ä¿å­˜å…ˆ:</strong> <span id="selectedPath" style="font-family: monospace"></span>
          </div>

          <button id="startAuthBtn" class="btn" style="padding: 12px 24px; background: #c0d6c0">
            GitHubã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>

          <button id="backToPathBtn" class="btn" style="padding: 8px 16px; margin-left: 8px">
            â† æˆ»ã‚‹
          </button>
        </div>

        <!-- Progress Bar -->
        <div id="progressContainer" class="progress-container">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div id="progressText" class="progress-text">æº–å‚™ä¸­...</div>
        </div>

        <!-- Step 3: Repository Selection -->
        <div id="stepRepoSelection" class="setup-step" style="display: none">
          <h2 style="font-size: 16px; margin: 0 0 12px 0">ğŸ“š ã‚¹ãƒ†ãƒƒãƒ—3: ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ</h2>
          <p style="margin: 0 0 16px 0; color: #666">
            ä½¿ç”¨ã™ã‚‹GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
          </p>

          <div
            style="background: #f0f0f0; padding: 12px; margin-bottom: 16px; border: 1px solid #ccc"
          >
            <strong>ä¿å­˜å…ˆ:</strong> <span id="selectedPath2" style="font-family: monospace"></span>
          </div>

          <div id="repoList" class="repo-list"></div>
          <div style="margin-top: 16px">
            <button
              id="cloneSelectedBtn"
              class="btn"
              style="padding: 12px 24px; background: #c0d6c0"
              disabled
            >
              ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†
            </button>
            <button id="backToAuthBtn" class="btn" style="padding: 8px 16px; margin-left: 8px">
              â† æˆ»ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <div
        id="githubSection"
        style="border-bottom: 2px solid #808080; padding: 8px; margin-bottom: 8px"
      >
        <h3 style="margin: 0 0 8px 0; font-size: 12px">GitHubçµ±åˆ</h3>
        <div id="githubStatus" style="font-size: 10px; margin-bottom: 4px; color: #666">æœªæ¥ç¶š</div>
        <div
          id="githubRepoInfo"
          style="
            font-size: 9px;
            margin-bottom: 4px;
            color: #333;
            word-break: break-all;
            display: none;
          "
        ></div>
        <button
          id="githubSyncBtn"
          class="btn"
          style="width: 100%; margin: 2px 0; font-size: 11px"
          disabled
        >
          åŒæœŸ
        </button>
        <button id="githubSetupBtn" class="btn" style="width: 100%; margin: 2px 0; font-size: 11px">
          ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ
        </button>
        <button
          id="githubCommitBtn"
          class="btn"
          style="width: 100%; margin: 2px 0; font-size: 11px; background: #c0d6c0"
          disabled
        >
          ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        </button>
      </div>
    </div>
    <div id="main">
      <div id="items">
        <button id="addBtn" class="btn add">+ è¿½åŠ </button>
        <table id="itemsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="editor">
        <div id="editorHeader">
          <button id="backBtn" class="btn">â† ä¸€è¦§ã¸æˆ»ã‚‹</button>
          <h2 id="editorTitle"></h2>
          <button id="deleteBtn" class="btn danger">å‰Šé™¤</button>
        </div>
        <textarea id="contentArea"></textarea>
      </div>
    </div>
    <div id="popupOverlay">
      <div id="popup"></div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div
      id="conflictModal"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      "
    >
      <div
        style="
          background: #d4d0c8;
          border: 2px solid #808080;
          width: 90%;
          max-width: 800px;
          max-height: 90%;
          overflow: auto;
          padding: 16px;
        "
      >
        <h2 style="margin: 0 0 16px 0; border-bottom: 1px solid #808080; padding-bottom: 8px">
          ğŸ“‹ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®è§£æ±º
        </h2>

        <div style="margin-bottom: 16px; padding: 8px; background: #fff; border: 1px solid #808080">
          <strong>ğŸ“– èª¬æ˜:</strong><br />
          ä»–ã®äººãŒåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã„ãŸãŸã‚ã€å¤‰æ›´ã‚’çµ±åˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br />
          å„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ã€ã©ã¡ã‚‰ã®å¤‰æ›´ã‚’æ¡ç”¨ã™ã‚‹ã‹é¸æŠã—ã¦ãã ã•ã„ã€‚
        </div>

        <div id="conflictFiles"></div>

        <div
          style="
            margin-top: 16px;
            text-align: center;
            border-top: 1px solid #808080;
            padding-top: 16px;
          "
        >
          <button
            id="completeConflictResolution"
            class="btn"
            style="margin-right: 8px; background: #c0d6c0"
            disabled
          >
            âœ… è§£æ±ºå®Œäº†
          </button>
          <button id="cancelConflictResolution" class="btn">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>
    <script>
      const sidebar = document.getElementById('sidebar');
      const itemsDiv = document.getElementById('items');
      const editorDiv = document.getElementById('editor');
      const itemsTableHead = document.querySelector('#itemsTable thead');
      const itemsTableBody = document.querySelector('#itemsTable tbody');
      const addBtn = document.getElementById('addBtn');
      const backBtn = document.getElementById('backBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const contentArea = document.getElementById('contentArea');
      const editorTitle = document.getElementById('editorTitle');

      let currentType = null;
      let currentId = null;
      let saveTimer = null;

      async function init() {
        const types = await window.api.getContentTypes();
        types.forEach((t) => {
          const btn = document.createElement('button');
          btn.textContent = t;
          btn.dataset.type = t;
          btn.onclick = () => selectType(t);
          sidebar.appendChild(btn);
        });
        if (types.length) selectType(types[0]);
      }

      async function selectType(type) {
        currentType = type;
        editorDiv.style.display = 'none';
        itemsDiv.style.display = 'block';
        loadItems();
        // Highlight active sidebar button
        Array.from(sidebar.querySelectorAll('button')).forEach((b) => {
          if (b.dataset.type === type) {
            b.classList.add('active');
          } else {
            b.classList.remove('active');
          }
        });
      }

      async function loadItems() {
        itemsTableBody.innerHTML = '';
        let tagsChoices = [];
        let memberTypeChoices = [];
        let memberChoices = [];
        if (currentType === 'member' || currentType === 'publication') {
          const tagsData = await window.api.getTableData('tags');
          tagsChoices = tagsData.rows.map((r) => ({ id: r.id, label: r.name || r.title || r.id }));
          if (currentType === 'member') {
            const memberTypeData = await window.api.getTableData('membertype');
            memberTypeChoices = memberTypeData.rows.map((r) => ({
              id: r.id,
              label: r.nameJa || r.name || r.title || r.id,
            }));
          }
          if (currentType === 'publication') {
            const memberData = await window.api.getTableData('member');
            memberChoices = memberData.rows.map((r) => ({
              id: r.id,
              label: r.nameJa || r.nameEn || r.name || r.id,
            }));
          }
        }
        const tableData = await window.api.getTableData(currentType);
        const headers = tableData.header;
        const rows = tableData.rows;

        // build header
        itemsTableHead.innerHTML = '<tr>' + headers.map((h) => `<th>${h}</th>`).join('') + '</tr>';

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          headers.forEach((col) => {
            const td = document.createElement('td');
            td.textContent = row[col] || '';
            if (col === 'id') {
              td.classList.add('id-cell', 'clickable');
              td.style.cursor = 'pointer';
              td.onclick = () => openEditor(row['id'], row[headers[1]] || '');
            } else if (col === 'thumbnail') {
              const img = document.createElement('img');
              if (row[col]) {
                window.api
                  .resolvePath(currentType, row[col])
                  .then((url) => (img.src = url + '?' + Date.now()));
              }
              img.style.width = '60px';
              img.style.height = '60px';
              img.style.objectFit = 'cover';
              img.style.cursor = 'pointer';
              img.onclick = async () => {
                const newPath = await window.api.selectThumbnail(currentType, row['id']);
                if (newPath) {
                  window.api
                    .resolvePath(currentType, newPath)
                    .then((url) => (img.src = url + '?' + Date.now()));
                  window.api.updateCell(currentType, row['id'], 'thumbnail', newPath);
                }
              };
              td.innerHTML = '';
              td.appendChild(img);
            } else if (currentType === 'member' && col === 'memberTypeId') {
              const valueName = memberTypeChoices.find((c) => c.id === row[col])?.label || row[col];
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = valueName + ' â–¾';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: false,
                  choices: memberTypeChoices,
                  selected: row[col] ? [row[col]] : [],
                  onConfirm: (vals) => {
                    const v = vals[0] || '';
                    window.api.updateCell(currentType, row['id'], 'memberTypeId', v);
                    btn.textContent = memberTypeChoices.find((c) => c.id === v)?.label || v;
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else if (
              (currentType === 'member' && col === 'tagIds') ||
              (currentType === 'publication' && col === 'tagIds')
            ) {
              const currentVals = (row[col] || '')
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);
              const names = tagsChoices
                .filter((c) => currentVals.includes(c.id))
                .map((c) => c.label)
                .join(',');
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = names || 'é¸æŠ â–¾';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: true,
                  choices: tagsChoices,
                  selected: currentVals,
                  onConfirm: (vals) => {
                    window.api.updateCell(currentType, row['id'], 'tagIds', vals.join(','));
                    const namesAfter = tagsChoices
                      .filter((c) => vals.includes(c.id))
                      .map((c) => c.label)
                      .join(',');
                    btn.textContent = namesAfter || 'é¸æŠ â–¾';
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else if (currentType === 'publication' && col === 'authorMemberIds') {
              const currentVals = (row[col] || '')
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);
              const names = memberChoices
                .filter((c) => currentVals.includes(c.id))
                .map((c) => c.label)
                .join(',');
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = names || 'é¸æŠ â–¾';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: true,
                  choices: memberChoices,
                  selected: currentVals,
                  onConfirm: (vals) => {
                    window.api.updateCell(
                      currentType,
                      row['id'],
                      'authorMemberIds',
                      vals.join(','),
                    );
                    const namesAfter = memberChoices
                      .filter((c) => vals.includes(c.id))
                      .map((c) => c.label)
                      .join(',');
                    btn.textContent = namesAfter || 'é¸æŠ â–¾';
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else {
              td.contentEditable = 'true';
              td.addEventListener('blur', () => {
                window.api.updateCell(currentType, row['id'], col, td.textContent);
              });
            }
            tr.appendChild(td);
          });
          itemsTableBody.appendChild(tr);
        });

        addBtn.onclick = async () => {
          await window.api.createItem(currentType);
          loadItems();
        };
      }

      async function openEditor(id, title) {
        currentId = id;
        editorDiv.style.display = 'flex';
        itemsDiv.style.display = 'none';
        editorTitle.textContent = `${currentType} / ${id} - ${title}`;
        const content = await window.api.loadContent(currentType, id);
        contentArea.value = content;

        // Set delete handler each time
        deleteBtn.onclick = async () => {
          if (confirm('å‰Šé™¤ã—ã¾ã™ã‹?')) {
            await window.api.deleteItem(currentType, id);
            // Return to list
            currentId = null;
            editorDiv.style.display = 'none';
            itemsDiv.style.display = 'block';
            loadItems();
          }
        };
      }

      backBtn.onclick = () => {
        editorDiv.style.display = 'none';
        itemsDiv.style.display = 'block';
        loadItems();
      };

      // Auto-save
      contentArea.addEventListener('input', () => {
        if (!currentId) return;
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          window.api.saveContent(currentType, currentId, contentArea.value);
        }, 500);
      });

      // Drag & Drop image insertion
      contentArea.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      contentArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        if (!currentId) return;
        const files = Array.from(e.dataTransfer.files);
        if (!files.length) return;
        const file = files[0];
        const isImage =
          file.type.startsWith('image/') || /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(file.name);
        if (!isImage) return;

        const markdownPath = await window.api.saveImage(
          currentType,
          currentId,
          file.path,
          file.name,
        );
        if (!markdownPath) return;

        // insert at cursor position
        const imgMarkdown = `![${file.name}](${markdownPath})`;
        const { selectionStart, selectionEnd, value } = contentArea;
        contentArea.value =
          value.slice(0, selectionStart) + imgMarkdown + value.slice(selectionEnd);
        // set cursor after inserted text
        const newPos = selectionStart + imgMarkdown.length;
        contentArea.selectionStart = contentArea.selectionEnd = newPos;
        // trigger save
        window.api.saveContent(currentType, currentId, contentArea.value);
      });

      init();

      // Style clickable id cells
      const styleEl = document.createElement('style');
      styleEl.textContent = `.clickable { color: #0000ee; text-decoration: underline; }`;
      document.head.appendChild(styleEl);

      // Popup helper
      function openSelectionPopup({ multiple, choices, selected, onConfirm }) {
        const overlay = document.getElementById('popupOverlay');
        const popup = document.getElementById('popup');
        popup.innerHTML = '';
        const title = document.createElement('h3');
        title.textContent = multiple ? 'ã‚¿ã‚°ã‚’é¸æŠ' : 'ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ';
        popup.appendChild(title);
        const listDiv = document.createElement('div');
        listDiv.className = 'choices';
        choices.forEach((c) => {
          const label = document.createElement('label');
          label.style.display = 'block';
          const input = document.createElement('input');
          input.type = multiple ? 'checkbox' : 'radio';
          input.name = 'choice';
          input.value = c.id;
          if (selected.includes(c.id)) input.checked = true;
          label.appendChild(input);
          label.appendChild(document.createTextNode(` ${c.label}`));
          listDiv.appendChild(label);
        });
        popup.appendChild(listDiv);
        const okBtn = document.createElement('button');
        okBtn.textContent = 'OK';
        okBtn.className = 'btn';
        const closePopup = () => {
          overlay.style.display = 'none';
          document.removeEventListener('keydown', escHandler);
        };
        const escHandler = (ev) => {
          if (ev.key === 'Escape') closePopup();
        };
        document.addEventListener('keydown', escHandler);
        okBtn.onclick = () => {
          const vals = Array.from(listDiv.querySelectorAll('input:checked')).map((i) => i.value);
          onConfirm(vals);
          closePopup();
        };
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'btn danger';
        cancelBtn.onclick = closePopup;
        popup.appendChild(okBtn);
        popup.appendChild(cancelBtn);
        overlay.style.display = 'flex';
      }

      // Load custom font
      window.api.getFontURL().then((url) => {
        if (!url) return;
        const style = document.createElement('style');
        style.textContent = `@font-face { font-family: CustomFont; src: url('${url}'); }
        body, button, table, textarea, input, select { font-family: 'CustomFont', sans-serif; }`;
        document.head.appendChild(style);
      });

      // ============================================================
      // GitHub Integration
      // ============================================================

      const githubStatus = document.getElementById('githubStatus');
      const githubRepoInfo = document.getElementById('githubRepoInfo');
      const githubSetupBtn = document.getElementById('githubSetupBtn');
      const githubSyncBtn = document.getElementById('githubSyncBtn');
      const githubCommitBtn = document.getElementById('githubCommitBtn');

      let githubConfig = null;

      // GitHub ãƒªãƒã‚¸ãƒˆãƒªé¸æŠãƒœã‚¿ãƒ³ï¼ˆåˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤ºï¼‰
      githubSetupBtn.onclick = () => {
        showInitialSetup();
      };

      // åŒæœŸï¼ˆãƒ—ãƒ«ï¼‰
      githubSyncBtn.onclick = async () => {
        if (!githubConfig) return;

        githubSyncBtn.disabled = true;
        githubSyncBtn.textContent = 'åŒæœŸä¸­...';

        try {
          const result = await window.api.githubPullLatest();
          if (result.success) {
            updateGitHubStatus('åŒæœŸå®Œäº†');
            // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            if (currentType) {
              loadItems();
            }
          } else if (result.hasConflicts) {
            // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆã€è§£æ±ºUIã‚’è¡¨ç¤º
            showConflictResolutionModal(result.conflicts || []);
          } else {
            alert('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
          }
        } catch (error) {
          console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
          alert('åŒæœŸã‚¨ãƒ©ãƒ¼: ' + error.message);
        }

        githubSyncBtn.disabled = false;
        githubSyncBtn.textContent = 'åŒæœŸ';
      };

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      githubCommitBtn.onclick = async () => {
        if (!githubConfig) return;

        const message = prompt(
          'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
          'Update content from CMS',
        );
        if (!message) return;

        githubCommitBtn.disabled = true;
        githubCommitBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

        try {
          const result = await window.api.githubCommitPush(message);
          if (result.success) {
            updateGitHubStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†');
          } else {
            alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
          }
        } catch (error) {
          console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }

        githubCommitBtn.disabled = false;
        githubCommitBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
      };

      // åˆæœŸãƒã‚§ãƒƒã‚¯ã¨åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
      checkInitialSetup().then(() => {
        // æ—¢ã«è¨­å®šæ¸ˆã¿ã®å ´åˆã®ã¿GitHubåˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        const existingConfig = localStorage.getItem('githubConfig');
        if (existingConfig) {
          initializeGitHub();
        }
      });

      // GitHubã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      function updateGitHubStatus(status) {
        githubStatus.textContent = status;
        setTimeout(() => {
          if (githubConfig) {
            githubStatus.textContent = `æ¥ç¶šæ¸ˆã¿ (${githubConfig.owner}/${githubConfig.repo})`;
          }
        }, 3000);
      }

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®GitHubçŠ¶æ…‹æ›´æ–°
      function updateSidebarGitHubStatus(status, config) {
        githubStatus.textContent = status;

        if (config) {
          githubRepoInfo.textContent = `${config.owner}/${config.repo}`;
          githubRepoInfo.style.display = 'block';
          githubSetupBtn.textContent = 'ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ';
          githubSyncBtn.disabled = false;
          githubCommitBtn.disabled = false;
        } else {
          githubRepoInfo.style.display = 'none';
          githubSetupBtn.textContent = 'ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ';
          githubSyncBtn.disabled = true;
          githubCommitBtn.disabled = true;
        }
      }

      // åˆæœŸåŒ–æ™‚ã«ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
      async function initializeGitHub() {
        console.log('DEBUG: Initializing GitHub configuration...');
        const savedConfig = localStorage.getItem('githubConfig');
        console.log('DEBUG: Saved config from localStorage:', savedConfig);

        if (savedConfig) {
          try {
            githubConfig = JSON.parse(savedConfig);
            console.log('DEBUG: Parsed GitHub config:', {
              owner: githubConfig.owner,
              repo: githubConfig.repo,
              localPath: githubConfig.localPath,
              hasToken: !!githubConfig.token,
            });

            // èªè¨¼çŠ¶æ…‹ç¢ºèª
            const isAuth = await window.api.githubIsAuthenticated();
            const isConfig = await window.api.githubIsConfigured();
            console.log('DEBUG: Auth status:', isAuth, 'Config status:', isConfig);

            if (isAuth && isConfig) {
              console.log('âœ… GitHub already configured and authenticated');
              updateSidebarGitHubStatus('æ¥ç¶šæ¸ˆã¿', githubConfig);
            } else {
              // è¨­å®šã‚’å¾©å…ƒ
              console.log('ğŸ”„ Restoring GitHub configuration...');
              if (githubConfig.token) {
                // æ–°ã—ã„å¾©å…ƒAPIã‚’ä½¿ç”¨
                const restoreResult = await window.api.githubRestoreConfig({
                  owner: githubConfig.owner,
                  repo: githubConfig.repo,
                  localPath: githubConfig.localPath,
                  token: githubConfig.token,
                });

                if (restoreResult.success) {
                  console.log('âœ… GitHub configuration restored successfully');
                  updateSidebarGitHubStatus('æ¥ç¶šæ¸ˆã¿', githubConfig);
                } else {
                  console.error('âŒ Failed to restore GitHub configuration:', restoreResult.error);
                  updateSidebarGitHubStatus('æœªæ¥ç¶š', null);
                }
              }
            }
          } catch (error) {
            console.error('âŒ GitHubè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            localStorage.removeItem('githubConfig');
            updateSidebarGitHubStatus('æœªæ¥ç¶š', null);
          }
        } else {
          console.log('ğŸ“­ No saved GitHub configuration found');
          updateSidebarGitHubStatus('æœªæ¥ç¶š', null);
        }
      }

      // ============================================================
      // Initial Setup Screen Logic
      // ============================================================

      const initialSetup = document.getElementById('initialSetup');
      const stepLocalPath = document.getElementById('stepLocalPath');
      const stepAuth = document.getElementById('stepAuth');
      const stepRepoSelection = document.getElementById('stepRepoSelection');

      const localPathInput = document.getElementById('localPath');
      const selectDirBtn = document.getElementById('selectDirBtn');
      const nextToAuthBtn = document.getElementById('nextToAuthBtn');
      const startAuthBtn = document.getElementById('startAuthBtn');
      const backToPathBtn = document.getElementById('backToPathBtn');
      const backToAuthBtn = document.getElementById('backToAuthBtn');

      const selectedPath = document.getElementById('selectedPath');
      const selectedPath2 = document.getElementById('selectedPath2');

      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const repoList = document.getElementById('repoList');
      const cloneSelectedBtn = document.getElementById('cloneSelectedBtn');

      let selectedRepository = null;
      let repositories = [];
      let setupProgress = null;
      let currentLocalPath = '';

      // ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã®ç®¡ç†
      function loadLocalSettings() {
        const saved = localStorage.getItem('cmsLocalSettings');
        if (saved) {
          try {
            const settings = JSON.parse(saved);
            localPathInput.value = settings.localPath || '';
            currentLocalPath = settings.localPath || '';
            updateNextButton();
          } catch (error) {
            console.error('Failed to load local settings:', error);
          }
        }
      }

      function saveLocalSettings() {
        const settings = {
          localPath: currentLocalPath,
          timestamp: Date.now(),
        };
        localStorage.setItem('cmsLocalSettings', JSON.stringify(settings));
      }

      // åˆå›èµ·å‹•æ™‚ã®åˆ¤å®š
      async function checkInitialSetup() {
        const existingConfig = localStorage.getItem('githubConfig');
        const isAuthenticated = await window.api.githubIsAuthenticated();

        if (existingConfig && isAuthenticated) {
          // æ—¢ã«è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’éè¡¨ç¤º
          initialSetup.classList.add('hidden');
        } else {
          // åˆå›ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆãŒå¿…è¦ãªå ´åˆã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º
          showInitialSetup();
          loadLocalSettings();
        }
      }

      function showInitialSetup() {
        initialSetup.classList.remove('hidden');
        showStep('localPath');
      }

      function hideInitialSetup() {
        initialSetup.classList.add('hidden');
      }

      function showStep(step) {
        stepLocalPath.style.display = step === 'localPath' ? 'block' : 'none';
        stepAuth.style.display = step === 'auth' ? 'block' : 'none';
        stepRepoSelection.style.display = step === 'repoSelection' ? 'block' : 'none';
      }

      function updateNextButton() {
        const hasPath = currentLocalPath.trim().length > 0;
        nextToAuthBtn.disabled = !hasPath;
      }

      // Step 1: Local Path Events
      localPathInput.addEventListener('input', (e) => {
        currentLocalPath = e.target.value;
        updateNextButton();
      });

      selectDirBtn.onclick = async () => {
        try {
          const result = await window.api.selectDirectory();
          if (result.success && result.path) {
            localPathInput.value = result.path;
            currentLocalPath = result.path;
            updateNextButton();
          } else {
            console.log('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          }
        } catch (error) {
          console.error('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      };

      nextToAuthBtn.onclick = () => {
        if (currentLocalPath.trim()) {
          saveLocalSettings();
          selectedPath.textContent = currentLocalPath;
          selectedPath2.textContent = currentLocalPath;
          showStep('auth');
        }
      };

      backToPathBtn.onclick = () => {
        showStep('localPath');
      };

      backToAuthBtn.onclick = () => {
        showStep('auth');
      };

      function showProgress(message, percent) {
        progressContainer.classList.add('show');
        progressFill.style.width = percent + '%';
        progressText.textContent = message;
      }

      function hideProgress() {
        progressContainer.classList.remove('show');
      }

      // GitHubèªè¨¼é–‹å§‹
      startAuthBtn.onclick = async () => {
        if (!currentLocalPath.trim()) {
          alert('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å…ˆã‚’è¨­å®šã—ã¦ãã ã•ã„');
          showStep('localPath');
          return;
        }

        startAuthBtn.disabled = true;
        startAuthBtn.textContent = 'GitHubã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

        try {
          showProgress('GitHubèªè¨¼ã‚’é–‹å§‹ä¸­...', 10);

          // OAuthèªè¨¼ï¼ˆè¨­å®šã¯å†…éƒ¨ã§ç®¡ç†ï¼‰
          const authResult = await window.api.githubOAuthAuthenticate();

          if (!authResult.success) {
            throw new Error(authResult.error || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          showProgress('ãƒªãƒã‚¸ãƒˆãƒªä¸€è¦§ã‚’å–å¾—ä¸­...', 40);

          // ãƒªãƒã‚¸ãƒˆãƒªä¸€è¦§ã‚’å–å¾—
          const repoResult = await window.api.githubGetUserRepositories();

          if (!repoResult.success) {
            throw new Error(repoResult.error || 'ãƒªãƒã‚¸ãƒˆãƒªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }

          repositories = repoResult.data;

          hideProgress();
          showRepositorySelection(repositories, authResult.token);
        } catch (error) {
          console.error('Setup error:', error);
          alert('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          startAuthBtn.disabled = false;
          startAuthBtn.textContent = 'GitHubã§ãƒ­ã‚°ã‚¤ãƒ³';
          hideProgress();
        }
      };

      // ãƒªãƒã‚¸ãƒˆãƒªé¸æŠç”»é¢ã‚’è¡¨ç¤º
      function showRepositorySelection(repos, token) {
        showStep('repoSelection');
        repoList.innerHTML = '';

        repos.forEach((repo) => {
          const repoItem = document.createElement('div');
          repoItem.className = 'repo-item';
          repoItem.dataset.repoId = repo.id;

          const repoName = document.createElement('div');
          repoName.className = 'repo-name';
          repoName.textContent = repo.full_name;

          const repoDescription = document.createElement('div');
          repoDescription.className = 'repo-description';
          repoDescription.textContent = repo.description || 'èª¬æ˜ãªã—';

          const repoMeta = document.createElement('div');
          repoMeta.className = 'repo-meta';

          if (repo.private) {
            const privateLabel = document.createElement('span');
            privateLabel.className = 'repo-private';
            privateLabel.textContent = 'Private';
            repoMeta.appendChild(privateLabel);
          }

          repoItem.appendChild(repoName);
          repoItem.appendChild(repoDescription);
          repoItem.appendChild(repoMeta);

          repoItem.onclick = () => selectRepository(repo, repoItem);

          repoList.appendChild(repoItem);
        });

        // ã‚¯ãƒ­ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        cloneSelectedBtn.onclick = () => {
          if (selectedRepository) {
            startCloning(selectedRepository, token);
          }
        };
      }

      // ãƒªãƒã‚¸ãƒˆãƒªé¸æŠ
      function selectRepository(repo, element) {
        // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
        document.querySelectorAll('.repo-item').forEach((item) => {
          item.classList.remove('selected');
        });

        // æ–°ã—ã„é¸æŠã‚’è¨­å®š
        element.classList.add('selected');
        selectedRepository = {
          ...repo,
          localBasePath: currentLocalPath,
          localPath: currentLocalPath + '/' + repo.name,
        };
        cloneSelectedBtn.disabled = false;
      }

      // ã‚¯ãƒ­ãƒ¼ãƒ³é–‹å§‹
      async function startCloning(repo, token) {
        cloneSelectedBtn.disabled = true;
        cloneSelectedBtn.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...';

        try {
          // ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šï¼ˆéšå±¤æ§‹é€ ã§ä¿å­˜ï¼‰
          const [owner, repoName] = repo.full_name.split('/');
          const finalLocalPath = repo.localPath; // /base/path/repo-name

          await window.api.githubSetRepository(owner, repoName, finalLocalPath, token);

          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
          const removeProgressListener = window.api.onGitHubCloneProgress((data) => {
            showProgress(data.message, data.percent);
          });

          showProgress('ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ä¸­...', 0);

          // ã‚¯ãƒ­ãƒ¼ãƒ³å®Ÿè¡Œ
          const cloneResult = await window.api.githubCloneWithProgress();

          removeProgressListener();

          if (cloneResult.success) {
            showProgress('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†', 100);

            // è¨­å®šã‚’ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã¨çµ±åˆï¼‰
            const config = {
              token,
              owner,
              repo: repoName,
              localPath: finalLocalPath,
              localBasePath: repo.localBasePath,
            };
            localStorage.setItem('githubConfig', JSON.stringify(config));

            // çŸ­ã„å¾…æ©Ÿå¾Œã«å®Œäº†
            setTimeout(() => {
              hideInitialSetup();
              hideProgress();

              // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–°
              githubConfig = config;
              updateSidebarGitHubStatus('æ¥ç¶šæ¸ˆã¿', githubConfig);

              // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯éè¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
              console.log('GitHubé€£æºã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ');
            }, 1000);
          } else {
            throw new Error(cloneResult.error || 'ã‚¯ãƒ­ãƒ¼ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } catch (error) {
          console.error('Clone error:', error);
          alert('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          cloneSelectedBtn.disabled = false;
          cloneSelectedBtn.textContent = 'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†';
          hideProgress();
        }
      }

      // ============================================================
      // Conflict Resolution
      // ============================================================

      const conflictModal = document.getElementById('conflictModal');
      const conflictFiles = document.getElementById('conflictFiles');
      const completeConflictResolution = document.getElementById('completeConflictResolution');
      const cancelConflictResolution = document.getElementById('cancelConflictResolution');

      let currentConflicts = [];
      let resolvedConflicts = new Set();

      // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      async function showConflictResolutionModal(conflicts) {
        currentConflicts = conflicts;
        resolvedConflicts.clear();

        // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰
        conflictFiles.innerHTML = '';

        for (const filePath of conflicts) {
          await createConflictFileUI(filePath);
        }

        updateCompleteButton();
        conflictModal.style.display = 'flex';
      }

      // å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºUIã‚’ä½œæˆ
      async function createConflictFileUI(filePath) {
        try {
          const contentResult = await window.api.githubGetConflictContent(filePath);
          if (!contentResult.success || !contentResult.data) {
            console.error('Failed to get conflict content for', filePath);
            return;
          }

          const content = contentResult.data;
          const { ours, theirs, merged } = parseConflictMarkers(content);

          const fileDiv = document.createElement('div');
          fileDiv.style.cssText = `
            margin-bottom: 20px;
            border: 2px solid #808080;
            background: #fff;
            padding: 12px;
          `;

          fileDiv.innerHTML = `
            <h3 style="margin: 0 0 12px 0; color: #000; border-bottom: 1px solid #ccc; padding-bottom: 4px;">
              ğŸ“„ ${filePath}
            </h3>
            
            <div style="margin-bottom: 12px;">
              <label style="font-weight: bold; margin-bottom: 4px; display: block;">
                <input type="radio" name="conflict-${CSS.escape(filePath)}" value="ours" style="margin-right: 8px;">
                ğŸŸ¢ ã‚ãªãŸã®å¤‰æ›´ã‚’æ¡ç”¨
              </label>
              <div style="background: #e6ffe6; border: 1px solid #90EE90; padding: 8px; margin-left: 20px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 150px; overflow: auto;">${ours.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
            </div>

            <div style="margin-bottom: 12px;">
              <label style="font-weight: bold; margin-bottom: 4px; display: block;">
                <input type="radio" name="conflict-${CSS.escape(filePath)}" value="theirs" style="margin-right: 8px;">
                ğŸ”´ ä»–ã®äººã®å¤‰æ›´ã‚’æ¡ç”¨
              </label>
              <div style="background: #ffe6e6; border: 1px solid #FFB6C1; padding: 8px; margin-left: 20px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 150px; overflow: auto;">${theirs.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
            </div>

            <div style="margin-bottom: 12px;">
              <label style="font-weight: bold; margin-bottom: 4px; display: block;">
                <input type="radio" name="conflict-${CSS.escape(filePath)}" value="manual" style="margin-right: 8px;">
                âœï¸ æ‰‹å‹•ã§ç·¨é›†
              </label>
              <textarea 
                id="manual-${CSS.escape(filePath)}" 
                style="width: 100%; height: 150px; margin-left: 20px; font-family: monospace; font-size: 12px; padding: 8px; border: 1px solid #808080;"
                placeholder="æ‰‹å‹•ã§å†…å®¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„..."
              >${merged.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </div>
          `;

          // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
          const radios = fileDiv.querySelectorAll(`input[name="conflict-${CSS.escape(filePath)}"]`);
          radios.forEach((radio) => {
            radio.addEventListener('change', () => {
              resolveConflictFile(filePath, radio.value, ours, theirs);
            });
          });

          conflictFiles.appendChild(fileDiv);
        } catch (error) {
          console.error('Error creating conflict UI for', filePath, error);
        }
      }

      // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ‘ãƒ¼ã‚¹
      function parseConflictMarkers(content) {
        const lines = content.split('\n');
        let ours = '';
        let theirs = '';
        let merged = '';
        let currentSection = 'normal';

        for (const line of lines) {
          if (line.startsWith('<<<<<<<')) {
            currentSection = 'ours';
            continue;
          } else if (line.startsWith('=======')) {
            currentSection = 'theirs';
            continue;
          } else if (line.startsWith('>>>>>>>')) {
            currentSection = 'normal';
            continue;
          }

          if (currentSection === 'ours') {
            ours += line + '\n';
          } else if (currentSection === 'theirs') {
            theirs += line + '\n';
          }

          merged += line + '\n';
        }

        return {
          ours: ours.trim(),
          theirs: theirs.trim(),
          merged: merged.trim(),
        };
      }

      // å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±º
      async function resolveConflictFile(filePath, choice, oursContent, theirsContent) {
        try {
          let resolvedContent = '';

          if (choice === 'ours') {
            resolvedContent = oursContent;
          } else if (choice === 'theirs') {
            resolvedContent = theirsContent;
          } else if (choice === 'manual') {
            const textarea = document.getElementById(`manual-${CSS.escape(filePath)}`);
            resolvedContent = textarea.value.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
          }

          const result = await window.api.githubResolveConflict(filePath, resolvedContent);
          if (result.success) {
            resolvedConflicts.add(filePath);
            console.log(`Conflict resolved for ${filePath}`);
          } else {
            alert(`ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã«å¤±æ•—: ${result.error}`);
            return;
          }

          updateCompleteButton();
        } catch (error) {
          console.error('Error resolving conflict:', error);
          alert('ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      }

      // å®Œäº†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      function updateCompleteButton() {
        const allResolved = resolvedConflicts.size === currentConflicts.length;
        completeConflictResolution.disabled = !allResolved;
      }

      // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºå®Œäº†
      completeConflictResolution.onclick = async () => {
        try {
          const result = await window.api.githubCompleteMerge('Resolve merge conflicts via CMS');
          if (result.success) {
            conflictModal.style.display = 'none';
            updateGitHubStatus('ãƒãƒ¼ã‚¸å®Œäº†');
            if (currentType) {
              loadItems();
            }
            alert('âœ… ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ­£å¸¸ã«è§£æ±ºã•ã‚Œã¾ã—ãŸï¼');
          } else {
            alert('ãƒãƒ¼ã‚¸å®Œäº†ã«å¤±æ•—: ' + result.error);
          }
        } catch (error) {
          console.error('Error completing merge:', error);
          alert('ãƒãƒ¼ã‚¸å®Œäº†ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
      };

      // ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚­ãƒ£ãƒ³ã‚»ãƒ«
      cancelConflictResolution.onclick = () => {
        if (confirm('ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ\nè§£æ±ºã—ã¦ã„ãªã„å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
          conflictModal.style.display = 'none';
        }
      };
    </script>
  </body>
</html>
