<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Morinolab CMS</title>
    <style>
      body {
        margin: 0;
        font-family: 'Chicago', 'Geneva', sans-serif;
        display: flex;
        height: 100vh;
        background: #c0c0c0; /* classic gray */
        color: #000;
      }
      #sidebar {
        flex: 0 0 180px; /* fixed width */
        width: 180px;
        background: #d4d0c8;
        border-right: 2px solid #808080;
        overflow-y: auto;
        overflow-x: hidden; /* disable horizontal scroll */
      }
      #sidebar button {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        color: #000;
        text-align: left;
        cursor: pointer;
        font-size: 13px;
        margin: 2px 0; /* vertical margin only to avoid width overflow */
      }
      #sidebar button:hover {
        background: #c8c4bc;
      }
      #sidebar button:active {
        border-top-color: #808080;
        border-left-color: #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
      }
      #sidebar button.active {
        position: relative;
        background: #d4d0c8; /* same as sidebar */
        color: #000;
        font-weight: bold;
      }
      #sidebar button.active::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 4px;
        background: #000080;
      }
      #main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: auto; /* allow scroll when content wider */
      }
      #items {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: #c0c0c0;
      }
      #editor {
        flex: 1;
        display: none;
        flex-direction: column;
      }
      #editorHeader {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #d4d0c8;
        border-bottom: 2px solid #808080;
        padding: 6px 8px;
      }
      #editorHeader h2 {
        flex: 1;
        margin: 0;
        font-size: 14px;
        font-weight: bold;
      }
      #editor textarea {
        width: 50%;
        flex: 0 0 50%;
        resize: none;
        font-family: monospace;
        font-size: 14px;
        padding: 12px;
        height: 100%;
        box-sizing: border-box;
        overflow-y: auto;
      }
      table {
        width: max-content; /* prevent squeezing, enable horizontal scroll */
        border-collapse: collapse;
        border: 2px solid #808080;
      }
      th,
      td {
        padding: 4px 8px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        text-align: left;
        background: #e0e0e0;
      }
      th {
        background: #d4d0c8;
        font-weight: bold;
      }
      .btn {
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 13px;
        color: #000;
        margin: 2px;
      }
      .btn:hover {
        background: #c8c4bc;
      }
      .btn:active {
        border-top-color: #808080;
        border-left-color: #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
      }
      .btn.add {
        background: #c0d6c0;
      }
      .btn.edit {
        background: #c0c8d6;
      }
      .btn.danger {
        background: #d6c0c0;
      }
      /* Mac OS 9 style scrollbars (WebKit-based browsers) */
      ::-webkit-scrollbar {
        width: 16px;
        height: 16px;
        background: #d4d0c8;
      }
      ::-webkit-scrollbar-track {
        background: #d4d0c8;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
      }
      ::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #b0b0b0;
      }
      ::-webkit-scrollbar-corner {
        background: #d4d0c8;
      }
      /* popup */
      #popupOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      #popup {
        background: #d4d0c8;
        border: 2px solid #808080;
        padding: 12px;
        max-height: 70vh;
        overflow: auto;
        min-width: 300px;
      }
      #popup h3 {
        margin-top: 0;
      }
      #popup .choices {
        max-height: 50vh;
        overflow: auto;
        margin-bottom: 12px;
      }
      #popup button {
        margin-right: 6px;
      }
      #popup .choices input[type='checkbox'],
      #popup .choices input[type='radio'] {
        appearance: none;
        width: 12px;
        height: 12px;
        margin-right: 4px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        vertical-align: middle;
      }
      #popup .choices input[type='checkbox']:checked,
      #popup .choices input[type='radio']:checked {
        background: #000080;
      }
      #popup .choices input[type='radio'] {
        border-radius: 50%;
      }
      .dropdownBtn {
        display: block;
        margin: 0 auto;
        padding: 2px 6px;
        border: 1px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        background: #d4d0c8;
        cursor: pointer;
        font-size: 12px;
      }
      .dropdownBtn:hover {
        background: #c8c4bc;
      }
      .dropdownBtn:active {
        border-top-color: #808080;
        border-left-color: #808080;
        border-bottom-color: #fff;
        border-right-color: #fff;
      }

      /* Initial Setup Screen */
      #initialSetup {
        position: fixed;
        inset: 0;
        background: #c0c0c0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      #initialSetup.hidden {
        display: none;
      }

      .setup-container {
        position: relative;
        background: #d4d0c8;
        border: 2px solid #808080;
        border-top-color: #fff;
        border-left-color: #fff;
        padding: 24px;
        max-width: 700px;
        width: 90%;
      }

      .setup-step {
        background: #f8f8f8;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .setup-title {
        margin: 0 0 16px 0;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
      }

      .setup-description {
        margin: 0 0 20px 0;
        font-size: 14px;
        line-height: 1.4;
        text-align: center;
        color: #333;
      }

      .setup-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .setup-form label {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .setup-form input {
        padding: 4px;
        border: 1px solid #808080;
        border-top-color: #000;
        border-left-color: #000;
        font-size: 14px;
      }

      .setup-form .form-group {
        display: flex;
        flex-direction: column;
      }

      .setup-form .note {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      /* Progress Bar */
      .progress-container {
        margin: 20px 0;
        display: none;
      }

      .progress-container.show {
        display: block;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        border: 1px solid #808080;
        border-top-color: #000;
        border-left-color: #000;
        background: #c0c0c0;
        position: relative;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #000080;
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
      }

      .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.2) 2px,
          rgba(255, 255, 255, 0.2) 4px
        );
      }

      .progress-text {
        text-align: center;
        margin-top: 8px;
        font-size: 12px;
        color: #333;
      }

      /* Split view container */
      #editorBody {
        flex: 0 0 600px; /* fixed height; adjust as needed */
        display: flex;
        overflow: hidden; /* prevent page scroll; children scroll instead */
      }
      /* Preview area */
      #previewArea {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
        overflow-x: hidden;
        background: #ffffff;
        border-left: 2px solid #808080;
        height: 100%;
        box-sizing: border-box;
      }
      #previewArea img {
        max-width: 100%;
        height: auto;
        display: block;
      }
    </style>
    <!-- Added Markdown renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <!-- Initial Setup Screen -->
    <div id="initialSetup">
      <div class="setup-container">
        <h1 class="setup-title">Ê£ÆÈáéÁ†îÁ©∂ÂÆ§HP CMS</h1>

        <!-- Quick Setup for Default Repository -->
        <div id="quickSetup" class="setup-step">
          <h2 style="font-size: 16px; margin: 0 0 12px 0">üöÄ „ÇØ„Ç§„ÉÉ„ÇØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó</h2>
          <p style="margin: 0 0 16px 0; color: #666">
            MorinolabÁ†îÁ©∂ÂÆ§„ÅÆ„Éá„Éï„Ç©„É´„Éà„É™„Éù„Ç∏„Éà„É™„Çí‰ΩøÁî®„Åó„Å¶„Åô„Åê„Å´ÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ<br />
            GitHub„Åß„É≠„Ç∞„Ç§„É≥„Åô„Çã„Å†„Åë„Åß„ÄÅ„É™„Éù„Ç∏„Éà„É™„ÅåËá™ÂãïÁöÑ„Å´„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Åï„Çå„Åæ„Åô„ÄÇ
          </p>

          <div class="form-group">
            <label for="quickLocalPath">‰øùÂ≠òÂÖà„Éá„Ç£„É¨„ÇØ„Éà„É™:</label>
            <div style="display: flex; gap: 8px; margin-top: 4px">
              <input
                type="text"
                id="quickLocalPath"
                style="flex: 1"
                placeholder="‰æã: /Users/username/Documents/morinolab"
              />
              <button id="selectQuickDirBtn" class="btn" style="padding: 8px 12px">
                „Éï„Ç©„É´„ÉÄÈÅ∏Êäû
              </button>
            </div>
          </div>

          <button
            id="quickStartBtn"
            class="btn"
            style="
              padding: 12px 24px;
              background: #c0d6c0;
              font-weight: bold;
              margin-top: 16px;
              display: block;
              margin-left: auto;
            "
            disabled
          >
            GitHub„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶ÈñãÂßã
          </button>
        </div>

        <!-- Progress Bar -->
        <div id="progressContainer" class="progress-container">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div id="progressText" class="progress-text">Ê∫ñÂÇô‰∏≠...</div>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <button
        id="conflictResolveBtn"
        class="btn danger"
        style="width: 100%; margin-bottom: 6px; font-size: 11px; display: none"
      >
        üõ†Ô∏è „Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê∂à
      </button>
      <div
        id="githubSection"
        style="border-bottom: 2px solid #808080; padding: 8px; margin-bottom: 8px"
      >
        <h3 style="margin: 0 0 8px 0; font-size: 12px">Ê£ÆÈáéÁ†îÁ©∂ÂÆ§HP</h3>
        <div id="githubStatus" style="font-size: 10px; margin-bottom: 4px; color: #666">Êú™Êé•Á∂ö</div>
        <div
          id="githubRepoInfo"
          style="
            font-size: 9px;
            margin-bottom: 4px;
            color: #333;
            word-break: break-all;
            display: none;
          "
        ></div>
        <button
          id="githubSetupBtn"
          class="btn"
          style="width: 100%; margin: 2px 0; font-size: 11px"
          disabled
        >
          „É≠„Ç∞„Ç¢„Ç¶„Éà
        </button>
        <button
          id="githubSyncBtn"
          class="btn"
          style="width: 100%; margin: 2px 0; font-size: 11px; background: #c0c8d6"
          disabled
        >
          ÂêåÊúü
        </button>
        <button
          id="githubCommitBtn"
          class="btn"
          style="width: 100%; margin: 2px 0; font-size: 11px; background: #c0d6c0"
          disabled
        >
          „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        </button>
      </div>
    </div>
    <div id="main">
      <div id="items">
        <button id="addBtn" class="btn add">+ ËøΩÂä†</button>
        <table id="itemsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>„Çø„Ç§„Éà„É´</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="editor">
        <div id="editorHeader">
          <button id="backBtn" class="btn">‚Üê ‰∏ÄË¶ß„Å∏Êàª„Çã</button>
          <h2 id="editorTitle"></h2>
          <button id="deleteBtn" class="btn danger">ÂâäÈô§</button>
        </div>
        <!-- Split editor body -->
        <div id="editorBody">
          <textarea id="contentArea"></textarea>
          <div id="previewArea"></div>
        </div>
      </div>
    </div>
    <div id="popupOverlay">
      <div id="popup"></div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div
      id="conflictModal"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      "
    >
      <div
        style="
          background: #d4d0c8;
          border: 2px solid #808080;
          width: 90%;
          max-width: 800px;
          max-height: 90%;
          overflow: auto;
          padding: 16px;
        "
      >
        <h2 style="margin: 0 0 16px 0; border-bottom: 1px solid #808080; padding-bottom: 8px">
          üìã „Éû„Éº„Ç∏„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅÆËß£Ê±∫
        </h2>

        <div style="margin-bottom: 16px; padding: 8px; background: #fff; border: 1px solid #808080">
          <strong>üìñ Ë™¨Êòé:</strong><br />
          ‰ªñ„ÅÆ‰∫∫„ÅåÂêå„Åò„Éï„Ç°„Ç§„É´„ÇíÁ∑®ÈõÜ„Åó„Å¶„ÅÑ„Åü„Åü„ÇÅ„ÄÅÂ§âÊõ¥„ÇíÁµ±Âêà„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br />
          ÂêÑ„Éï„Ç°„Ç§„É´„Å´„Å§„ÅÑ„Å¶„ÄÅ„Å©„Å°„Çâ„ÅÆÂ§âÊõ¥„ÇíÊé°Áî®„Åô„Çã„ÅãÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </div>

        <div id="conflictFiles"></div>

        <div
          style="
            margin-top: 16px;
            text-align: center;
            border-top: 1px solid #808080;
            padding-top: 16px;
          "
        >
          <button
            id="completeConflictResolution"
            class="btn"
            style="margin-right: 8px; background: #c0d6c0"
            disabled
          >
            ‚úÖ Ëß£Ê±∫ÂÆå‰∫Ü
          </button>
          <button id="cancelConflictResolution" class="btn">‚ùå „Ç≠„É£„É≥„Çª„É´</button>
        </div>
      </div>
    </div>
    <script>
      const sidebar = document.getElementById('sidebar');
      const itemsDiv = document.getElementById('items');
      const editorDiv = document.getElementById('editor');
      const itemsTableHead = document.querySelector('#itemsTable thead');
      const itemsTableBody = document.querySelector('#itemsTable tbody');
      const addBtn = document.getElementById('addBtn');
      const backBtn = document.getElementById('backBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const contentArea = document.getElementById('contentArea');
      const editorTitle = document.getElementById('editorTitle');
      const previewArea = document.getElementById('previewArea');

      let currentType = null;
      let currentId = null;
      let saveTimer = null;

      async function init() {
        // Remove previously generated type buttons to avoid duplication when re-initialising
        Array.from(sidebar.querySelectorAll('button')).forEach((b) => {
          if (b.dataset && b.dataset.type) {
            b.remove();
          }
        });

        const types = await window.api.getContentTypes();
        types.forEach((t) => {
          const btn = document.createElement('button');
          btn.textContent = t;
          btn.dataset.type = t;
          btn.onclick = () => selectType(t);
          sidebar.appendChild(btn);
        });
        if (types.length) selectType(types[0]);
      }

      async function selectType(type) {
        currentType = type;
        editorDiv.style.display = 'none';
        itemsDiv.style.display = 'block';
        loadItems();
        // Highlight active sidebar button
        Array.from(sidebar.querySelectorAll('button')).forEach((b) => {
          if (b.dataset.type === type) {
            b.classList.add('active');
          } else {
            b.classList.remove('active');
          }
        });
      }

      async function loadItems() {
        itemsTableBody.innerHTML = '';
        let tagsChoices = [];
        let memberTypeChoices = [];
        let memberChoices = [];
        if (currentType === 'member' || currentType === 'publication') {
          const tagsData = await window.api.getTableData('tags');
          tagsChoices = tagsData.rows.map((r) => ({ id: r.id, label: r.name || r.title || r.id }));
          if (currentType === 'member') {
            const memberTypeData = await window.api.getTableData('membertype');
            memberTypeChoices = memberTypeData.rows.map((r) => ({
              id: r.id,
              label: r.nameJa || r.name || r.title || r.id,
            }));
          }
          if (currentType === 'publication') {
            const memberData = await window.api.getTableData('member');
            memberChoices = memberData.rows.map((r) => ({
              id: r.id,
              label: r.nameJa || r.nameEn || r.name || r.id,
            }));
          }
        } else if (currentType === 'award') {
          // For award content, we need member list for memberIds selection
          const memberData = await window.api.getTableData('member');
          memberChoices = memberData.rows.map((r) => ({
            id: r.id,
            label: r.nameJa || r.nameEn || r.name || r.id,
          }));
        }
        const tableData = await window.api.getTableData(currentType);
        const headers = tableData.header;
        const rows = tableData.rows;

        // build header
        itemsTableHead.innerHTML = '<tr>' + headers.map((h) => `<th>${h}</th>`).join('') + '</tr>';

        rows.forEach((row) => {
          const tr = document.createElement('tr');
          headers.forEach((col) => {
            const td = document.createElement('td');
            td.textContent = row[col] || '';
            if (col === 'id') {
              td.classList.add('id-cell', 'clickable');
              td.style.cursor = 'pointer';
              td.onclick = () => openEditor(row['id'], row[headers[1]] || '');
            } else if (col === 'thumbnail') {
              const img = document.createElement('img');
              if (row[col]) {
                window.api
                  .resolvePath(currentType, row[col])
                  .then((url) => (img.src = url + '?' + Date.now()));
              }
              img.style.width = '60px';
              img.style.height = '60px';
              img.style.objectFit = 'cover';
              img.style.cursor = 'pointer';
              img.onclick = async () => {
                const newPath = await window.api.selectThumbnail(currentType, row['id']);
                if (newPath) {
                  window.api
                    .resolvePath(currentType, newPath)
                    .then((url) => (img.src = url + '?' + Date.now()));
                  window.api.updateCell(currentType, row['id'], 'thumbnail', newPath);
                }
              };
              td.innerHTML = '';
              td.appendChild(img);
            } else if (currentType === 'member' && col === 'memberTypeId') {
              const valueName = memberTypeChoices.find((c) => c.id === row[col])?.label || row[col];
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = valueName + ' ‚ñæ';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: false,
                  choices: memberTypeChoices,
                  selected: row[col] ? [row[col]] : [],
                  onConfirm: (vals) => {
                    const v = vals[0] || '';
                    window.api.updateCell(currentType, row['id'], 'memberTypeId', v);
                    btn.textContent = memberTypeChoices.find((c) => c.id === v)?.label || v;
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else if (
              (currentType === 'member' && col === 'tagIds') ||
              (currentType === 'publication' && col === 'tagIds')
            ) {
              const currentVals = (row[col] || '')
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);
              const names = tagsChoices
                .filter((c) => currentVals.includes(c.id))
                .map((c) => c.label)
                .join(',');
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = names || 'ÈÅ∏Êäû ‚ñæ';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: true,
                  choices: tagsChoices,
                  selected: currentVals,
                  onConfirm: (vals) => {
                    window.api.updateCell(currentType, row['id'], 'tagIds', vals.join(','));
                    const namesAfter = tagsChoices
                      .filter((c) => vals.includes(c.id))
                      .map((c) => c.label)
                      .join(',');
                    btn.textContent = namesAfter || 'ÈÅ∏Êäû ‚ñæ';
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else if (currentType === 'publication' && col === 'authorMemberIds') {
              const currentVals = (row[col] || '')
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);
              const names = memberChoices
                .filter((c) => currentVals.includes(c.id))
                .map((c) => c.label)
                .join(',');
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = names || 'ÈÅ∏Êäû ‚ñæ';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: true,
                  choices: memberChoices,
                  selected: currentVals,
                  onConfirm: (vals) => {
                    window.api.updateCell(
                      currentType,
                      row['id'],
                      'authorMemberIds',
                      vals.join(','),
                    );
                    const namesAfter = memberChoices
                      .filter((c) => vals.includes(c.id))
                      .map((c) => c.label)
                      .join(',');
                    btn.textContent = namesAfter || 'ÈÅ∏Êäû ‚ñæ';
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else if (currentType === 'award' && col === 'memberIds') {
              const currentVals = (row[col] || '')
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);
              const names = memberChoices
                .filter((c) => currentVals.includes(c.id))
                .map((c) => c.label)
                .join(',');
              const btn = document.createElement('button');
              btn.className = 'dropdownBtn';
              btn.textContent = names || 'ÈÅ∏Êäû ‚ñæ';
              btn.onclick = (e) => {
                e.stopPropagation();
                openSelectionPopup({
                  multiple: true,
                  choices: memberChoices,
                  selected: currentVals,
                  onConfirm: (vals) => {
                    window.api.updateCell(currentType, row['id'], 'memberIds', vals.join(','));
                    const namesAfter = memberChoices
                      .filter((c) => vals.includes(c.id))
                      .map((c) => c.label)
                      .join(',');
                    btn.textContent = namesAfter || 'ÈÅ∏Êäû ‚ñæ';
                  },
                });
              };
              td.innerHTML = '';
              td.appendChild(btn);
            } else {
              td.contentEditable = 'true';
              td.addEventListener('blur', () => {
                window.api.updateCell(currentType, row['id'], col, td.textContent);
              });
            }
            tr.appendChild(td);
          });
          itemsTableBody.appendChild(tr);
        });

        addBtn.onclick = async () => {
          await window.api.createItem(currentType);
          loadItems();
        };
      }

      async function openEditor(id, title) {
        currentId = id;
        editorDiv.style.display = 'flex';
        itemsDiv.style.display = 'none';
        editorTitle.textContent = `${currentType} / ${id} - ${title}`;
        const content = await window.api.loadContent(currentType, id);
        contentArea.value = content;
        updatePreview();

        // Set delete handler each time
        deleteBtn.onclick = async () => {
          if (confirm('ÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
            await window.api.deleteItem(currentType, id);
            // Return to list
            currentId = null;
            editorDiv.style.display = 'none';
            itemsDiv.style.display = 'block';
            loadItems();
          }
        };
      }

      backBtn.onclick = () => {
        editorDiv.style.display = 'none';
        itemsDiv.style.display = 'block';
        loadItems();
      };

      // Auto-save
      contentArea.addEventListener('input', () => {
        if (!currentId) return;
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          window.api.saveContent(currentType, currentId, contentArea.value);
        }, 500);
        updatePreview();
      });

      // Drag & Drop image insertion
      contentArea.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      contentArea.addEventListener('drop', async (e) => {
        e.preventDefault();
        if (!currentId) return;
        const files = Array.from(e.dataTransfer.files);
        if (!files.length) return;
        const file = files[0];
        const isImage =
          file.type.startsWith('image/') || /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(file.name);
        if (!isImage) return;

        const markdownPath = await window.api.saveImage(
          currentType,
          currentId,
          file.path,
          file.name,
        );
        if (!markdownPath) return;

        // insert at cursor position
        const imgMarkdown = `![${file.name}](${markdownPath})`;
        const { selectionStart, selectionEnd, value } = contentArea;
        contentArea.value =
          value.slice(0, selectionStart) + imgMarkdown + value.slice(selectionEnd);
        // set cursor after inserted text
        const newPos = selectionStart + imgMarkdown.length;
        contentArea.selectionStart = contentArea.selectionEnd = newPos;
        // trigger save
        window.api.saveContent(currentType, currentId, contentArea.value);
        updatePreview();
      });

      init();

      // Style clickable id cells
      const styleEl = document.createElement('style');
      styleEl.textContent = `.clickable { color: #0000ee; text-decoration: underline; }`;
      document.head.appendChild(styleEl);

      // Popup helper
      function openSelectionPopup({ multiple, choices, selected, onConfirm }) {
        const overlay = document.getElementById('popupOverlay');
        const popup = document.getElementById('popup');
        popup.innerHTML = '';
        const title = document.createElement('h3');
        title.textContent = multiple ? '„Çø„Ç∞„ÇíÈÅ∏Êäû' : '„Çø„Ç§„Éó„ÇíÈÅ∏Êäû';
        popup.appendChild(title);
        const listDiv = document.createElement('div');
        listDiv.className = 'choices';
        choices.forEach((c) => {
          const label = document.createElement('label');
          label.style.display = 'block';
          const input = document.createElement('input');
          input.type = multiple ? 'checkbox' : 'radio';
          input.name = 'choice';
          input.value = c.id;
          if (selected.includes(c.id)) input.checked = true;
          label.appendChild(input);
          label.appendChild(document.createTextNode(` ${c.label}`));
          listDiv.appendChild(label);
        });
        popup.appendChild(listDiv);
        const okBtn = document.createElement('button');
        okBtn.textContent = 'OK';
        okBtn.className = 'btn';
        const closePopup = () => {
          overlay.style.display = 'none';
          document.removeEventListener('keydown', escHandler);
        };
        const escHandler = (ev) => {
          if (ev.key === 'Escape') closePopup();
        };
        document.addEventListener('keydown', escHandler);
        okBtn.onclick = () => {
          const vals = Array.from(listDiv.querySelectorAll('input:checked')).map((i) => i.value);
          onConfirm(vals);
          closePopup();
        };
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.className = 'btn danger';
        cancelBtn.onclick = closePopup;
        popup.appendChild(okBtn);
        popup.appendChild(cancelBtn);
        overlay.style.display = 'flex';
      }

      // Custom input dialog for commit message (replacement for window.prompt)
      function getCommitMessage(defaultMessage = 'Update content from CMS') {
        return new Promise((resolve) => {
          const overlay = document.getElementById('popupOverlay');
          const popup = document.getElementById('popup');

          // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
          popup.innerHTML = '';

          // „Çø„Ç§„Éà„É´
          const title = document.createElement('h3');
          title.textContent = '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ';
          popup.appendChild(title);

          // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ
          const input = document.createElement('input');
          input.type = 'text';
          input.value = defaultMessage;
          input.style.cssText = 'width: 100%; padding: 4px; margin-bottom: 12px;';
          popup.appendChild(input);

          // „Éú„Çø„É≥„Ç≥„É≥„ÉÜ„Éä
          const btnContainer = document.createElement('div');
          btnContainer.style.textAlign = 'right';

          const okBtn = document.createElement('button');
          okBtn.textContent = 'OK';
          okBtn.className = 'btn';
          okBtn.style.marginRight = '8px';

          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = '„Ç≠„É£„É≥„Çª„É´';
          cancelBtn.className = 'btn danger';

          const close = (value) => {
            overlay.style.display = 'none';
            document.removeEventListener('keydown', escHandler);
            resolve(value);
          };

          okBtn.onclick = () => {
            close(input.value.trim());
          };
          cancelBtn.onclick = () => {
            close(null);
          };

          btnContainer.appendChild(okBtn);
          btnContainer.appendChild(cancelBtn);
          popup.appendChild(btnContainer);

          const escHandler = (ev) => {
            if (ev.key === 'Escape') close(null);
            if (ev.key === 'Enter') close(input.value.trim());
          };
          document.addEventListener('keydown', escHandler);

          overlay.style.display = 'flex';
          input.focus();
          input.select();
        });
      }

      // Load custom font
      window.api.getFontURL().then((url) => {
        if (!url) return;
        const style = document.createElement('style');
        style.textContent = `@font-face { font-family: CustomFont; src: url('${url}'); }
        body, button, table, textarea, input, select { font-family: 'CustomFont', sans-serif; }`;
        document.head.appendChild(style);
      });

      // ============================================================
      // GitHub Integration
      // ============================================================

      const githubStatus = document.getElementById('githubStatus');
      const githubRepoInfo = document.getElementById('githubRepoInfo');
      const githubSetupBtn = document.getElementById('githubSetupBtn');
      const githubSyncBtn = document.getElementById('githubSyncBtn');
      const githubCommitBtn = document.getElementById('githubCommitBtn');
      const conflictResolveBtn = document.getElementById('conflictResolveBtn');

      let githubConfig = null;

      // GitHub „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Éú„Çø„É≥ÔºàÂàùÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„ÇíË°®Á§∫Ôºâ
      githubSetupBtn.onclick = () => {
        // Êó¢„Å´Êé•Á∂öÊ∏à„Åø„Å™„Çâ„É≠„Ç∞„Ç¢„Ç¶„ÉàÁ¢∫Ë™ç
        const isConnected = !!githubConfig;
        if (isConnected) {
          const ok = confirm(
            'GitHub „Åã„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü\n„É≠„Éº„Ç´„É´„Å´‰øùÂ≠ò„Åï„Çå„Åü„Éà„Éº„ÇØ„É≥ÊÉÖÂ†±„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ',
          );
          if (!ok) return;

          // Ë®≠ÂÆö„ÇíÂâäÈô§
          localStorage.removeItem('githubConfig');
          githubConfig = null;
          updateSidebarGitHubStatus('Êú™Êé•Á∂ö', null);
        }

        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„ÇíË°®Á§∫
        showInitialSetup();
      };

      // ÂêåÊúüÔºàpullÔºâ
      githubSyncBtn.onclick = async () => {
        if (!githubConfig) return;

        try {
          githubSyncBtn.disabled = true;
          githubSyncBtn.textContent = 'ÂêåÊúü‰∏≠...';

          showProgress('„É™„É¢„Éº„Éà„Åã„ÇâÊúÄÊñ∞„ÅÆÂ§âÊõ¥„ÇíÂèñÂæó‰∏≠...', 10);

          // pull„ÇíÂÆüË°å
          const pullRes = await window.api.githubPullLatest();

          if (!pullRes.success) {
            // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÄÅ„Ç≥„É≥„Éï„É™„ÇØ„Éà„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (pullRes.hasConflicts && pullRes.conflicts && pullRes.conflicts.length > 0) {
              hideProgress();
              showConflictResolutionModal(pullRes.conflicts);
            } else {
              hideProgress();
              alert('ÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (pullRes.error || 'Unknown error'));
            }
          } else {
            showProgress('ÂêåÊúüÂÆå‰∫Ü', 100);
            updateGitHubStatus('ÂêåÊúüÂÆå‰∫Ü');
            if (currentType) loadItems(); // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            await refreshConflictState();
            setTimeout(hideProgress, 1000);
          }
        } catch (error) {
          console.error('ÂêåÊúü„Ç®„É©„Éº:', error);
          alert('ÂêåÊúü„Ç®„É©„Éº: ' + error.message);
          hideProgress();
        } finally {
          githubSyncBtn.disabled = false;
          githubSyncBtn.textContent = 'ÂêåÊúü';
        }
      };

      // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      githubCommitBtn.onclick = async () => {
        if (!githubConfig) return;

        const message = 'Update content from CMS';

        // Open real-time progress dialog
        openGitProgressDialog();

        githubCommitBtn.disabled = true;
        githubCommitBtn.textContent = '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...';

        // „Åæ„Åö pull „Åó„Å¶ÊúÄÊñ∞„Å´ÂêåÊúü
        showProgress('„É™„É¢„Éº„Éà„ÅÆÂ§âÊõ¥„ÇíÂèñÂæó‰∏≠...', 5);
        appendGitProgressLine('„É™„É¢„Éº„Éà„ÅÆÂ§âÊõ¥„ÇíÂèñÂæó‰∏≠...');

        const pullRes = await window.api.githubPullLatest();

        if (pullRes.hasConflicts) {
          showConflictResolutionModal(pullRes.conflicts || []);
          showProgress('„Éû„Éº„Ç∏„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 0);
          appendGitProgressLine('„Éû„Éº„Ç∏„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
          // pull „Åß„Ç≥„É≥„Éï„É™„ÇØ„Éà‚Üí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠Ê≠¢
          githubCommitBtn.disabled = false;
          githubCommitBtn.textContent = '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ';
          setTimeout(() => {
            hideProgress();
            closeGitProgressDialog();
            refreshConflictState();
          }, 500);
          return;
        }

        // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫„É™„Çπ„Éä„Éº
        const removeCommitProgressListener = window.api.onGitHubCommitProgress((data) => {
          showProgress(data.message, data.percent);
          appendGitProgressLine(data.message);
        });

        try {
          const result = await window.api.githubCommitPush(message);
          if (result.success) {
            updateGitHubStatus('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü');
            showProgress('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü', 100);
            appendGitProgressLine('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü');
            await refreshConflictState();
          } else if (result.hasConflicts) {
            // „Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÄÅËß£Ê±∫UI„ÇíË°®Á§∫
            showConflictResolutionModal(result.conflicts || []);
            showProgress('„Éû„Éº„Ç∏„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 0);
            appendGitProgressLine('„Éû„Éº„Ç∏„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            await refreshConflictState();
          } else {
            alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || 'Unknown error'));
            showProgress('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 0);
            appendGitProgressLine(
              '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (result.error || 'Unknown error'),
            );
          }
        } catch (error) {
          console.error('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
          alert('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: ' + error.message);
          showProgress('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº', 0);
          appendGitProgressLine('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: ' + error.message);
        }

        githubCommitBtn.disabled = false;
        githubCommitBtn.textContent = '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ';

        // „Éó„É≠„Ç∞„É¨„ÇπËß£Èô§
        removeCommitProgressListener();
        setTimeout(() => {
          hideProgress();
          closeGitProgressDialog();
        }, 1000);
      };

      // ÂàùÊúü„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÂàùÊúüÂåñ„ÇíÂÆüË°å
      checkInitialSetup().then(() => {
        // Êó¢„Å´Ë®≠ÂÆöÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅÆ„ÅøGitHubÂàùÊúüÂåñ„ÇíÂÆüË°å
        const existingConfig = localStorage.getItem('githubConfig');
        if (existingConfig) {
          initializeGitHub();
        }
      });

      // GitHub„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
      function updateGitHubStatus(status) {
        githubStatus.textContent = status;
        setTimeout(() => {
          if (githubConfig) {
            githubStatus.textContent = `Êé•Á∂öÊ∏à„Åø (${githubConfig.owner}/${githubConfig.repo})`;
          }
        }, 3000);
      }

      // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆGitHubÁä∂ÊÖãÊõ¥Êñ∞
      function updateSidebarGitHubStatus(status, config) {
        githubStatus.textContent = status;

        // Ensure the setup/logout button is always clickable
        githubSetupBtn.disabled = false;

        if (config) {
          githubRepoInfo.textContent = `${config.owner}/${config.repo}`;
          githubRepoInfo.style.display = 'block';
          githubSetupBtn.textContent = '„É≠„Ç∞„Ç¢„Ç¶„Éà';
          githubSyncBtn.disabled = false;
          githubCommitBtn.disabled = false;
        } else {
          githubRepoInfo.style.display = 'none';
          githubSetupBtn.textContent = '„É≠„Ç∞„Ç§„É≥/„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó';
          githubSyncBtn.disabled = true;
          githubCommitBtn.disabled = true;
        }
      }

      // ÂàùÊúüÂåñÊôÇ„Å´‰øùÂ≠ò„Åï„Çå„ÅüË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
      async function initializeGitHub() {
        console.log('DEBUG: Initializing GitHub configuration...');
        const savedConfig = localStorage.getItem('githubConfig');
        console.log('DEBUG: Saved config from localStorage:', savedConfig);

        if (savedConfig) {
          try {
            githubConfig = JSON.parse(savedConfig);
            console.log('DEBUG: Parsed GitHub config:', {
              owner: githubConfig.owner,
              repo: githubConfig.repo,
              localPath: githubConfig.localPath,
              hasToken: !!githubConfig.token,
            });

            // Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç
            const isAuth = await window.api.githubIsAuthenticated();
            const isConfig = await window.api.githubIsConfigured();
            console.log('DEBUG: Auth status:', isAuth, 'Config status:', isConfig);

            if (isAuth && isConfig) {
              console.log('‚úÖ GitHub already configured and authenticated');
              updateSidebarGitHubStatus('Êé•Á∂öÊ∏à„Åø', githubConfig);
            } else {
              // Ë®≠ÂÆö„ÇíÂæ©ÂÖÉ
              console.log('üîÑ Restoring GitHub configuration...');
              if (githubConfig.token) {
                // Êñ∞„Åó„ÅÑÂæ©ÂÖÉAPI„Çí‰ΩøÁî®
                const restoreResult = await window.api.githubRestoreConfig({
                  owner: githubConfig.owner,
                  repo: githubConfig.repo,
                  localPath: githubConfig.localPath,
                  token: githubConfig.token,
                });

                if (restoreResult.success) {
                  console.log('‚úÖ GitHub configuration restored successfully');
                  updateSidebarGitHubStatus('Êé•Á∂öÊ∏à„Åø', githubConfig);
                } else {
                  console.error('‚ùå Failed to restore GitHub configuration:', restoreResult.error);
                  updateSidebarGitHubStatus('Êú™Êé•Á∂ö', null);
                }
              }
            }
          } catch (error) {
            console.error('‚ùå GitHubË®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            localStorage.removeItem('githubConfig');
            updateSidebarGitHubStatus('Êú™Êé•Á∂ö', null);
          }
        } else {
          console.log('üì≠ No saved GitHub configuration found');
          updateSidebarGitHubStatus('Êú™Êé•Á∂ö', null);
        }
      }

      // ============================================================
      // Initial Setup Screen Logic
      // ============================================================

      const initialSetup = document.getElementById('initialSetup');
      const quickSetup = document.getElementById('quickSetup');

      // Quick setup elements
      const quickLocalPathInput = document.getElementById('quickLocalPath');
      const selectQuickDirBtn = document.getElementById('selectQuickDirBtn');
      const quickStartBtn = document.getElementById('quickStartBtn');

      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      let setupProgress = null;

      // „É≠„Éº„Ç´„É´Ë®≠ÂÆö„ÅÆÁÆ°ÁêÜ
      async function loadLocalSettings() {
        const saved = localStorage.getItem('cmsLocalSettings');
        if (saved) {
          try {
            const settings = JSON.parse(saved);
            // „ÇØ„Ç§„ÉÉ„ÇØ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁî®„ÅÆ„Éë„Çπ„ÇíË®≠ÂÆö
            if (settings.localPath) {
              quickLocalPathInput.value = settings.localPath;
              updateQuickStartButton();
            }
          } catch (error) {
            console.error('Failed to load local settings:', error);
          }
        } else {
          // „Éá„Éï„Ç©„É´„Éà„Éë„Çπ„ÇíAPI„Åã„ÇâÂèñÂæó
          try {
            const result = await window.api.getDefaultLocalPath();
            if (result.success && result.path) {
              quickLocalPathInput.value = result.path;
              updateQuickStartButton();
            }
          } catch (error) {
            console.error('Failed to get default path:', error);
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            quickLocalPathInput.value = '/Documents/morinolab';
            updateQuickStartButton();
          }
        }
      }

      function saveLocalSettings(pathToSave = null) {
        const settings = {
          localPath: pathToSave || quickLocalPathInput.value,
          timestamp: Date.now(),
        };
        localStorage.setItem('cmsLocalSettings', JSON.stringify(settings));
      }

      // ÂàùÂõûËµ∑ÂãïÊôÇ„ÅÆÂà§ÂÆö
      async function checkInitialSetup() {
        const existingConfig = localStorage.getItem('githubConfig');
        const isAuthenticated = await window.api.githubIsAuthenticated();
        const isRepoConfigured = await window.api.githubIsConfigured();

        if (existingConfig && isAuthenticated && isRepoConfigured) {
          // Êó¢„Å´Ë®≠ÂÆöÊ∏à„Åø„Åã„Å§„É≠„Éº„Ç´„É´„Éï„Ç©„É´„ÉÄ„ÇÇÂ≠òÂú®
          initialSetup.classList.add('hidden');
        } else {
          // „Éï„Ç©„É´„ÉÄ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØË≠¶Âëä„ÇíË°®Á§∫
          if (existingConfig && isAuthenticated && !isRepoConfigured) {
            alert('„É≠„Éº„Ç´„É´„É™„Éù„Ç∏„Éà„É™„Éï„Ç©„É´„ÉÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂÜç„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            // Âè§„ÅÑ config „ÅØÊÆã„Åô„ÅãÔºü ÈÅ©ÂÆúÂâäÈô§„ÇÇÂèØ
          }

          // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„ÇíË°®Á§∫
          showInitialSetup();
          await loadLocalSettings();
        }
      }

      function showInitialSetup() {
        initialSetup.classList.remove('hidden');
        showStep('quick');
        // „É™„Çª„ÉÉ„Éà: ÂâçÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊôÇ„Å´Â§âÊõ¥„Åï„Çå„Åü„Éú„Çø„É≥Áä∂ÊÖã„ÇíÂÖÉ„Å´Êàª„Åô
        quickStartBtn.disabled = false;
        quickStartBtn.textContent = 'GitHub„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶ÈñãÂßã';
        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÂàùÊúü„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„Å´Êàª„Åô
        if (!initialSetup.contains(progressContainer)) {
          const setupContainer = initialSetup.querySelector('.setup-container');
          if (setupContainer) {
            setupContainer.appendChild(progressContainer);
            // „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            progressContainer.style.position = '';
            progressContainer.style.bottom = '';
            progressContainer.style.left = '';
            progressContainer.style.transform = '';
            progressContainer.style.width = '';
            progressContainer.style.maxWidth = '';
            progressContainer.style.zIndex = '';
          }
        }
      }

      function hideInitialSetup() {
        initialSetup.classList.add('hidden');
        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÁîªÈù¢„É´„Éº„ÉàÁõ¥‰∏ã„Å´ÁßªÂãï„Åó„Å¶Â∏∏„Å´Ë°®Á§∫„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
        if (document.body && !document.body.contains(progressContainer)) {
          document.body.appendChild(progressContainer);
          // „Ç∞„É≠„Éº„Éê„É´Ë°®Á§∫Áî®„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
          progressContainer.style.position = 'fixed';
          progressContainer.style.bottom = '40px';
          progressContainer.style.left = '50%';
          progressContainer.style.transform = 'translateX(-50%)';
          progressContainer.style.width = '90%';
          progressContainer.style.maxWidth = '600px';
          progressContainer.style.zIndex = '2000';
        }
      }

      function showStep(step) {
        quickSetup.style.display = step === 'quick' ? 'block' : 'none';
      }

      function updateQuickStartButton() {
        const hasPath = quickLocalPathInput.value.trim().length > 0;
        quickStartBtn.disabled = !hasPath;
      }

      // Quick Setup Events
      quickLocalPathInput.addEventListener('input', updateQuickStartButton);

      selectQuickDirBtn.onclick = async () => {
        try {
          const result = await window.api.selectDirectory();
          if (result.success && result.path) {
            quickLocalPathInput.value = result.path;
            updateQuickStartButton();
          }
        } catch (error) {
          console.error('„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû„Ç®„É©„Éº:', error);
          alert('„Éá„Ç£„É¨„ÇØ„Éà„É™ÈÅ∏Êäû„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
      };

      function showProgress(message, percent) {
        progressContainer.classList.add('show');
        progressFill.style.width = percent + '%';
        progressText.textContent = message;
      }

      function hideProgress() {
        progressContainer.classList.remove('show');
      }

      // Quick Start - Default Repository Setup
      quickStartBtn.onclick = async () => {
        const quickPath = quickLocalPathInput.value.trim();
        if (!quickPath) {
          alert('„É≠„Éº„Ç´„É´‰øùÂ≠òÂÖà„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }

        quickStartBtn.disabled = true;
        quickStartBtn.textContent = '„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó‰∏≠...';

        try {
          showProgress('GitHubË™çË®º„ÇíÈñãÂßã‰∏≠...', 10);

          // OAuthË™çË®º
          const authResult = await window.api.githubOAuthAuthenticate();
          if (!authResult.success) {
            throw new Error(authResult.error || 'Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }

          showProgress('„Éá„Éï„Ç©„É´„Éà„É™„Éù„Ç∏„Éà„É™„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó‰∏≠...', 40);

          // „Éá„Éï„Ç©„É´„Éà„É™„Éù„Ç∏„Éà„É™„ÅÆË®≠ÂÆö
          const defaultOwner = 'MorinoLab-SIT';
          const defaultRepo = 'morinolab_hp';
          const finalLocalPath = quickPath + '/' + defaultRepo;

          // „É™„Éù„Ç∏„Éà„É™Ë®≠ÂÆö
          await window.api.githubSetRepository(
            defaultOwner,
            defaultRepo,
            finalLocalPath,
            authResult.token,
          );

          showProgress('„É™„Éù„Ç∏„Éà„É™„Çí„ÇØ„É≠„Éº„É≥‰∏≠...', 60);

          // „Éó„É≠„Ç∞„É¨„Çπ„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
          const removeProgressListener = window.api.onGitHubCloneProgress((data) => {
            const adjustedPercent = 60 + data.percent * 0.35; // 60% „Åã„Çâ 95% „Åæ„Åß„ÅÆÁØÑÂõ≤
            showProgress(data.message, adjustedPercent);
          });

          // „ÇØ„É≠„Éº„É≥ÂÆüË°å
          const cloneResult = await window.api.githubCloneWithProgress();
          removeProgressListener();

          if (!cloneResult.success) {
            throw new Error(cloneResult.error || '„ÇØ„É≠„Éº„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }

          showProgress('„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü', 100);

          // Ë®≠ÂÆö„Çí‰øùÂ≠ò
          const config = {
            token: authResult.token,
            owner: defaultOwner,
            repo: defaultRepo,
            localPath: finalLocalPath,
            localBasePath: quickPath,
          };
          localStorage.setItem('githubConfig', JSON.stringify(config));

          // „É≠„Éº„Ç´„É´Ë®≠ÂÆö„ÇÇ‰øùÂ≠ò
          saveLocalSettings(quickPath);

          // GitHub„ÅÆË®≠ÂÆö„ÇíÂèçÊò†
          githubConfig = config;

          setTimeout(() => {
            hideInitialSetup();
            hideProgress();
            updateSidebarGitHubStatus('Êé•Á∂öÊ∏à„Åø', githubConfig);
            // Re-initialise sidebar and item list so that freshly cloned contents appear
            init();
          }, 1000);
        } catch (error) {
          console.error('Quick setup error:', error);
          alert('„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
          quickStartBtn.disabled = false;
          quickStartBtn.textContent = 'GitHub„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶ÈñãÂßã';
          hideProgress();
        }
      };

      // ============================================================
      // Conflict Resolution
      // ============================================================

      const conflictModal = document.getElementById('conflictModal');
      const conflictFiles = document.getElementById('conflictFiles');
      const completeConflictResolution = document.getElementById('completeConflictResolution');
      const cancelConflictResolution = document.getElementById('cancelConflictResolution');

      let currentConflicts = [];
      let resolvedConflicts = new Set();

      // „Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê±∫„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      async function showConflictResolutionModal(conflicts) {
        currentConflicts = conflicts;
        resolvedConflicts.clear();

        // „Ç≥„É≥„Éï„É™„ÇØ„Éà„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„ÇíÊßãÁØâ
        conflictFiles.innerHTML = '';

        for (const filePath of conflicts) {
          await createConflictFileUI(filePath);
        }

        updateCompleteButton();
        conflictModal.style.display = 'flex';
      }

      // ÂÄãÂà•„Éï„Ç°„Ç§„É´„ÅÆ„Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê±∫UI„Çí‰ΩúÊàêÔºà3„Ç´„É©„É†ÊØîËºÉÊñπÂºèÔºâ
      async function createConflictFileUI(filePath) {
        try {
          const versionsResult = await window.api.githubGetConflictVersions(filePath);
          if (!versionsResult.success || !versionsResult.data) {
            console.error('Failed to get conflict versions for', filePath);
            return;
          }

          const { current, incoming, base } = versionsResult.data;

          const fileDiv = document.createElement('div');
          fileDiv.style.cssText = `margin-bottom: 20px; border: 2px solid #808080; background: #fff; padding: 12px;`;

          // Header
          const header = document.createElement('h3');
          header.textContent = `üìÑ ${filePath}`;
          header.style.cssText =
            'margin:0 0 12px 0; border-bottom:1px solid #ccc; padding-bottom:4px;';
          fileDiv.appendChild(header);

          // ÈÅ∏Êäû„Éú„Çø„É≥Áæ§
          const buttonGroup = document.createElement('div');
          buttonGroup.style.cssText =
            'margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap;';

          const useCurrentBtn = document.createElement('button');
          useCurrentBtn.textContent = 'ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÊé°Áî®';
          useCurrentBtn.className = 'btn';
          useCurrentBtn.style.background = '#c0d6c0';

          const useIncomingBtn = document.createElement('button');
          useIncomingBtn.textContent = '„É™„É¢„Éº„Éà„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÇíÊé°Áî®';
          useIncomingBtn.className = 'btn';
          useIncomingBtn.style.background = '#d6c0c0';

          const manualEditBtn = document.createElement('button');
          manualEditBtn.textContent = 'ÊâãÂãïÁ∑®ÈõÜ';
          manualEditBtn.className = 'btn';
          manualEditBtn.style.background = '#c0c8d6';

          buttonGroup.appendChild(useCurrentBtn);
          buttonGroup.appendChild(useIncomingBtn);
          buttonGroup.appendChild(manualEditBtn);
          fileDiv.appendChild(buttonGroup);

          // ÊØîËºÉË°®Á§∫
          const compareDiv = document.createElement('div');
          compareDiv.style.cssText =
            'display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;';

          // ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥
          const currentDiv = document.createElement('div');
          currentDiv.style.cssText = 'border: 1px solid #808080; background: #f0f8f0;';
          const currentLabel = document.createElement('div');
          currentLabel.textContent = 'ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥ („É≠„Éº„Ç´„É´Â§âÊõ¥)';
          currentLabel.style.cssText =
            'background: #c0d6c0; padding: 4px 8px; font-weight: bold; font-size: 11px;';
          const currentContent = document.createElement('pre');
          currentContent.style.cssText =
            'padding: 8px; margin: 0; font-family: monospace; font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow: auto;';
          currentContent.textContent = current || '(ÂÜÖÂÆπ„Å™„Åó)';
          currentDiv.appendChild(currentLabel);
          currentDiv.appendChild(currentContent);

          // „É™„É¢„Éº„Éà„ÅÆ„Éê„Éº„Ç∏„Éß„É≥
          const incomingDiv = document.createElement('div');
          incomingDiv.style.cssText = 'border: 1px solid #808080; background: #f8f0f0;';
          const incomingLabel = document.createElement('div');
          incomingLabel.textContent = '„É™„É¢„Éº„Éà„ÅÆ„Éê„Éº„Ç∏„Éß„É≥ (origin/main)';
          incomingLabel.style.cssText =
            'background: #d6c0c0; padding: 4px 8px; font-weight: bold; font-size: 11px;';
          const incomingContent = document.createElement('pre');
          incomingContent.style.cssText =
            'padding: 8px; margin: 0; font-family: monospace; font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow: auto;';
          incomingContent.textContent = incoming || '(ÂÜÖÂÆπ„Å™„Åó)';
          incomingDiv.appendChild(incomingLabel);
          incomingDiv.appendChild(incomingContent);

          compareDiv.appendChild(currentDiv);
          compareDiv.appendChild(incomingDiv);
          fileDiv.appendChild(compareDiv);

          // ÊâãÂãïÁ∑®ÈõÜ„Ç®„É™„Ç¢ÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ
          const editDiv = document.createElement('div');
          editDiv.style.cssText = 'display: none; margin-bottom: 12px;';
          const editLabel = document.createElement('div');
          editLabel.textContent = 'ÊâãÂãïÁ∑®ÈõÜ:';
          editLabel.style.cssText = 'margin-bottom: 4px; font-weight: bold;';
          const textarea = document.createElement('textarea');
          textarea.id = `edit-${CSS.escape(filePath)}`;
          textarea.style.cssText =
            'width:100%; height:250px; font-family:monospace; font-size:12px; margin-bottom:8px;';
          textarea.value = current || incoming || '';
          editDiv.appendChild(editLabel);
          editDiv.appendChild(textarea);
          fileDiv.appendChild(editDiv);

          // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
          const statusDiv = document.createElement('div');
          statusDiv.style.cssText =
            'margin-top: 8px; padding: 8px; background: #f0f0f0; border: 1px solid #ccc;';
          const statusSpan = document.createElement('span');
          statusSpan.textContent = '‚è≥ ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          statusDiv.appendChild(statusSpan);
          fileDiv.appendChild(statusDiv);

          // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
          let selectedContent = null;

          useCurrentBtn.onclick = async () => {
            selectedContent = current || '';
            const res = await window.api.githubResolveConflict(filePath, selectedContent);
            if (res.success) {
              statusSpan.textContent = '‚úÖ ÁèæÂú®„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅßËß£Ê±∫Ê∏à„Åø';
              statusDiv.style.background = '#e8f5e8';
              resolvedConflicts.add(filePath);
              updateCompleteButton();
            } else {
              alert('‰øùÂ≠ò„Å´Â§±Êïó: ' + res.error);
            }
          };

          useIncomingBtn.onclick = async () => {
            selectedContent = incoming || '';
            const res = await window.api.githubResolveConflict(filePath, selectedContent);
            if (res.success) {
              statusSpan.textContent = '‚úÖ „É™„É¢„Éº„Éà„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅßËß£Ê±∫Ê∏à„Åø';
              statusDiv.style.background = '#e8f5e8';
              resolvedConflicts.add(filePath);
              updateCompleteButton();
            } else {
              alert('‰øùÂ≠ò„Å´Â§±Êïó: ' + res.error);
            }
          };

          manualEditBtn.onclick = () => {
            editDiv.style.display = 'block';
            statusSpan.textContent = '‚úèÔ∏è ÊâãÂãïÁ∑®ÈõÜ„É¢„Éº„Éâ';
            statusDiv.style.background = '#f8f8e8';

            // ÊâãÂãïÁ∑®ÈõÜ‰øùÂ≠ò„Éú„Çø„É≥„ÇíËøΩÂä†
            if (!editDiv.querySelector('.manual-save-btn')) {
              const saveBtn = document.createElement('button');
              saveBtn.textContent = '‰øùÂ≠ò';
              saveBtn.className = 'btn manual-save-btn';
              saveBtn.style.background = '#c0d6c0';
              saveBtn.onclick = async () => {
                const newContent = textarea.value;
                const res = await window.api.githubResolveConflict(filePath, newContent);
                if (res.success) {
                  statusSpan.textContent = '‚úÖ ÊâãÂãïÁ∑®ÈõÜ„ÅßËß£Ê±∫Ê∏à„Åø';
                  statusDiv.style.background = '#e8f5e8';
                  resolvedConflicts.add(filePath);
                  updateCompleteButton();
                } else {
                  alert('‰øùÂ≠ò„Å´Â§±Êïó: ' + res.error);
                }
              };
              editDiv.appendChild(saveBtn);
            }
          };

          conflictFiles.appendChild(fileDiv);
        } catch (error) {
          console.error('Error creating conflict UI for', filePath, error);
        }
      }

      // ÂÆå‰∫Ü„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
      function updateCompleteButton() {
        const allResolved = resolvedConflicts.size === currentConflicts.length;
        completeConflictResolution.disabled = !allResolved;
      }

      // „Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê±∫ÂÆå‰∫Ü ‚Üí „Éû„Éº„Ç∏„Ç≥„Éü„ÉÉ„Éà & „Éó„ÉÉ„Ç∑„É•
      completeConflictResolution.onclick = async () => {
        try {
          showProgress('„Éû„Éº„Ç∏„Ç≥„Éü„ÉÉ„Éà„Çí‰ΩúÊàê‰∏≠...', 10);

          // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
          completeConflictResolution.disabled = true;

          const mergeRes = await window.api.githubCompleteMerge('Resolve merge conflicts via CMS');

          if (mergeRes.success) {
            showProgress('„Éû„Éº„Ç∏ÂÆå‰∫Ü„Éª„Éó„ÉÉ„Ç∑„É•ÂÆå‰∫Ü', 100);
            setTimeout(() => {
              hideProgress();
              conflictModal.style.display = 'none';
              updateGitHubStatus('„Éû„Éº„Ç∏ÂÆå‰∫Ü');
              if (currentType) loadItems();
              refreshConflictState();
            }, 1000);
          } else {
            hideProgress();
            console.error('Merge completion failed:', mergeRes.error);

            // „Ç®„É©„Éº„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„Åü„É°„ÉÉ„Çª„Éº„Ç∏
            let errorMessage = '„Éû„Éº„Ç∏ÂÆå‰∫Ü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
            if (mergeRes.error && mergeRes.error.includes('GitPushError')) {
              errorMessage =
                '„É™„É¢„Éº„Éà„É™„Éù„Ç∏„Éà„É™„ÅßÊñ∞„Åó„ÅÑÂ§âÊõ¥„Åå„ÅÇ„Å£„Åü„Åü„ÇÅ„ÄÅ„Éû„Éº„Ç∏„ÇíÂÆå‰∫Ü„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\nÂÜçÂ∫¶ÂêåÊúü„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åã„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
            } else if (mergeRes.error && mergeRes.error.includes('cannot lock ref')) {
              errorMessage =
                '„É™„É¢„Éº„Éà„Éñ„É©„É≥„ÉÅ„Åå„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\nÂ∞ë„ÅóÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
            } else if (mergeRes.error) {
              errorMessage += '\nË©≥Á¥∞: ' + mergeRes.error;
            }

            alert(errorMessage);

            // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
            const allResolved = resolvedConflicts.size === currentConflicts.length;
            completeConflictResolution.disabled = !allResolved;
          }
        } catch (error) {
          hideProgress();
          console.error('Error completing merge:', error);
          alert('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);

          // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
          const allResolved = resolvedConflicts.size === currentConflicts.length;
          completeConflictResolution.disabled = !allResolved;
        }
      };

      // „Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê±∫„Ç≠„É£„É≥„Çª„É´
      cancelConflictResolution.onclick = () => {
        if (confirm('„Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê±∫„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô„ÅãÔºü\nËß£Ê±∫„Åó„Å¶„ÅÑ„Å™„ÅÑÂ§âÊõ¥„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ')) {
          conflictModal.style.display = 'none';
        }
      };

      // ====== Git Progress Dialog ======
      let progressDialog = null;
      let progressPre = null;

      function openGitProgressDialog() {
        const overlay = document.getElementById('popupOverlay');
        const popup = document.getElementById('popup');
        popup.innerHTML = '';

        const title = document.createElement('h3');
        title.textContent = 'Git „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈÄ≤Ë°åÁä∂Ê≥Å';
        popup.appendChild(title);

        progressPre = document.createElement('pre');
        progressPre.style.cssText =
          'white-space: pre-wrap; max-height: 300px; overflow:auto; background:#fff; border:1px solid #808080; padding:8px; font-family: inherit; font-size: 12px;';
        popup.appendChild(progressPre);

        progressDialog = { overlay, popup };
        overlay.style.display = 'flex';
      }

      function appendGitProgressLine(text) {
        if (!progressPre) return;
        progressPre.textContent += text + '\n';
        progressPre.scrollTop = progressPre.scrollHeight;
      }

      function closeGitProgressDialog() {
        if (progressDialog) {
          progressDialog.overlay.style.display = 'none';
          progressDialog = null;
          progressPre = null;
        }
      }

      // „Ç≥„É≥„Éï„É™„ÇØ„ÉàÁä∂ÊÖã„ÇíÊõ¥Êñ∞„Åó UI „ÇíÂà∂Âæ°
      async function refreshConflictState() {
        try {
          const res = await window.api.githubGetConflicts();
          const has = res.success && res.data && res.data.length > 0;
          if (has) {
            conflictResolveBtn.style.display = 'block';
            githubSyncBtn.disabled = true;
            githubCommitBtn.disabled = true;
          } else {
            conflictResolveBtn.style.display = 'none';
            // „Éú„Çø„É≥ÊúâÂäπÂåñ„ÅØÊé•Á∂öÁä∂ÊÖã„Å´‰æùÂ≠ò
            if (githubConfig) {
              githubSyncBtn.disabled = false;
              githubCommitBtn.disabled = false;
            }
          }
        } catch (e) {
          console.error('Failed to check conflicts', e);
        }
      }

      // Ëµ∑ÂãïÊôÇ„ÉÅ„Çß„ÉÉ„ÇØ
      refreshConflictState();

      // „Ç≥„É≥„Éï„É™„ÇØ„ÉàËß£Ê∂à„Éú„Çø„É≥ÔºàÊú™Ëß£Ê±∫„Åå„ÅÇ„ÇãÂ†¥Âêà„Å´Ë°®Á§∫Ôºâ
      conflictResolveBtn.onclick = async () => {
        const res = await window.api.githubGetConflicts();
        if (res.success && res.data && res.data.length) {
          showConflictResolutionModal(res.data);
        } else {
          alert('ÁèæÂú®Ëß£Ê∂à„ÅåÂøÖË¶Å„Å™„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
          refreshConflictState();
        }
      };

      function updatePreview() {
        if (window.marked && previewArea) {
          previewArea.innerHTML = window.marked.parse(contentArea.value);
        } else if (previewArea) {
          previewArea.textContent = contentArea.value;
        }

        // Fix image sources to absolute file URLs
        if (!currentType || !currentId) return;
        const imgs = previewArea.querySelectorAll('img');
        imgs.forEach((img) => {
          const srcAttr = img.getAttribute('src');
          if (!srcAttr) return;
          // Skip if already absolute (http/https/data/file)
          if (/^(https?:|data:|file:)/i.test(srcAttr)) return;

          // Build relative path within type/id folder
          const combinedRel = `${currentId}/${srcAttr.replace(/^\.\//, '')}`;
          window.api
            .resolvePath(currentType, combinedRel)
            .then((url) => {
              if (url) img.src = url + '?' + Date.now();
            })
            .catch(() => {});
        });
      }
    </script>
  </body>
</html>
